---
title: "aggregated_figures"
author: "Juliano Palacios Abrantes"
date: "`r Sys.Date()`"
output: html_document
---

This script is used to produce the data and figures for the aggregated results of the scenarios paper. It includes the relative changes in biomass for different scenarios and time periods, as well as comparisons between protected and non-protected areas.


```{r setup, include = F}

# Load functions
source("/Users/jepa88/GitHub/etpmc_cc/functions/mpa_names_fx.R")
source("/Users/jepa88/GitHub/etpmc_cc/functions/scenario_names_fx.R")


library(MyFunctions)

my_lib(c(
  # For grid estimation and species selection
  "tidyverse","sf",
  # For collaborative ease
  "here",
  #For standarize data
  "scales",
  "zoo",
  # For pretty plots
  "wesanderson",
  "tidytext",
  "ggh4x", # faceting edditing
  # Statistics
  "mgcv",
  "patchwork",
  "gratia"
))

# For grid e
# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)

select <- dplyr::select


# Change paths to your computer

data_path <- "~/Library/CloudStorage/GoogleDrive-jepa88@gmail.com/My Drive/lenfest_mpa_project/data/"


results_path <- "~/Library/CloudStorage/GoogleDrive-jepa88@gmail.com/My Drive/lenfest_mpa_project/data/03 results/scenarios_paper/"
```

# Aggregated results

## Data load

```{r load_data}

# Load pre created data

scenarios_data_abs <- read_csv(
  paste0(data_path,"04 raw dbem results/processed/all/","all_years_data_abd_esm.csv")
) %>% 
  filter(region != "High seas")


# Load sau data 
sau_sf <- my_sf("SAU") %>% 
  filter(name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador"))

# Load CMAR shapefile
cmar_sf <- read_sf(paste0(data_path,"01 spatial/cmar_capas/cmar_shp/all_cmar_mpas.shp")) %>% 
  slice(-4,-5,-9)

```

## Data prep

```{r}
sq_df <- scenarios_data_abs %>% 
  filter(scen == "sq") %>% 
  filter(year < 2014) %>% 
  group_by(region,esm,ssp) %>%
  summarise(mean_time = mean(value_region, na.rm = T)) %>% 
  group_by(region,ssp) %>%
  summarise(mean_esm = mean(mean_time, na.rm = T))


data_df <- scenarios_data_abs %>% 
  mutate(
    time_frame = case_when(
      # year > 1994 & year < 2014 ~ "historic",
      year < 2015 ~ "historic",
      year > 2021 & year < 2040 ~ "early_2030",
      year > 2041 & year < 2060 ~ "mid_2050",
      TRUE ~ NA_character_
    )
  ) %>% 
  filter(!is.na(time_frame)) %>% 
  group_by(region,scen,esm,ssp,time_frame) %>%
  summarise(mean_time = mean(value_region, na.rm = T)) %>% 
  group_by(region,scen,ssp,time_frame) %>% 
  pivot_wider(names_from = time_frame, values_from = mean_time) %>% 
  # left_join(sq_df) %>% 
  mutate(
    dif_2030 = my_chng(historic,early_2030),
    dif_2050 = my_chng(historic,mid_2050)
    # dif_2040sq = my_chng(mean_esm,early_2050),
  ) %>% 
  scenario_names(leng = "eng") %>% 
  # filter(!is.na(dif_2040)) %>% 
  # filter(region != "High seas") %>% 
  summarise(
    across(
      c(dif_2030, dif_2050),
      list(mean_esm = ~mean(.x, na.rm = TRUE),
           sd_esm = ~sd(.x, na.rm = TRUE)),
      .names = "{.col}_{.fn}"
    ),
    .groups = "drop"
  ) %>% 
  pivot_longer(cols = c("dif_2030_mean_esm": "dif_2050_sd_esm"),
               names_to = "period",
               values_to = "value") %>% 
  mutate(
    stat = ifelse(str_detect(period, "mean"), "mean_esm", "sd_esm"),
    period = ifelse(str_detect(period, "2030"), "2030", "2050"),
    ssp = ifelse(ssp == "ssp126", "SSP1-2.6","SSP5-8.5")
  )


```


## Fig. 2, Relative to historic period (Year)

```{r}

hist_df <- scenarios_data_abs %>%
  filter(scen == "sq",
         region != "High seas"
  ) %>%
  filter(year < 2015) %>%
  group_by(esm,ssp,scen) %>%
  summarise(mean_time = mean(value_region, na.rm = T),
            .groups = "drop" 
  )


esm_mean <- scenarios_data_abs %>% 
  mutate(year = as.numeric(year)) %>%
  filter(
    region != "High seas",
    scen == "sq") %>%
  group_by(year,esm,ssp,scen) %>%
  summarise(future_time = mean(value_region, na.rm = T),
            .groups = "drop" 
  ) %>%
  left_join(hist_df,
            by = c("esm", "ssp", "scen")
  ) %>% 
  mutate(
    per_change = my_chng(mean_time,future_time)
  )

scenarios_data_abs %>% 
  mutate(year = as.numeric(year)) %>%
  filter(
    region != "High seas",
    scen == "sq") %>%
  group_by(year,esm,ssp,scen) %>%
  summarise(future_time = mean(value_region, na.rm = T),
            .groups = "drop" 
  ) %>%
  left_join(hist_df,
            by = c("esm", "ssp", "scen")
  ) %>% 
  mutate(
    per_change = my_chng(mean_time,future_time)
  ) %>% 
  group_by(year,ssp,scen) %>%
  mutate(esm_mean = mean(per_change, na.rm = T)) %>% 
  group_by(scen,ssp,esm) %>%
  mutate(
    rolling_mean_sem = rollmean(esm_mean, k = 5, fill = NA, align = "right")
  ) %>%
  filter(year > 2015) %>% 
  # View()
  # write_csv(.,paste0(data_path,"03 results/dbem/all_species/","percentage_change_by_year.csv"))
  ggplot() +
  geom_line(
    aes(
      x = year,
      y = per_change,
      color = ssp,
      linetype = esm
    ),
    alpha = 0.5
  ) +
  geom_line(
    aes(
      x = year,
      y = rolling_mean_sem,
      color = ssp
    )
  ) +
  geom_vline(xintercept = 2060, linetype = "dashed", color = "grey")+
  scale_linetype("Earth system model") +
  scale_y_continuous("Change in biomass relative to baseline (%)",
                     limits = c(-70,10),
                     labels = seq(-70,10,10),
                     breaks = seq(-70,10,10)
  ) +
  xlab("Year") +
  my_ggtheme_p(leg_pos = "right",
               leg_tx_s = 8,
               leg_tl_s = 9,
               ax_tx_s = 8,
               ax_tl_s = 9,
               x_hjust = 0.5) +
  scale_color_manual("Climate change scenario",
                     values = c(wes_palette("Zissou1",type = "discrete")[1],
                                wes_palette("Zissou1",type = "discrete")[5]
                     )
  )

ggsave(
  paste0(results_path,"figures/relative_hist/all/","sq_relative_historic_cmar.png"),
  last_plot(),
  height = 3,
  width = 6
)


```

## Fig. 3. Relative to historic period bar plot (Delta)

Note that there is two options for presenting this result:

- One option is to compare each scenario to its own, in this case, aesthetics for the map should be `aes(fill = dif_2040)` and the file name `relative_historic_scen_85.png`

- A second option is to compare each scenario to the historical SQ, as William suggested. In this case, aesthetics for the map should be `aes(fill = dif_2040sq)` and the file name `relative_historic_scen_85.png`

```{r}

data_df %>% 
  filter(scen == "sq",
         region != "High seas") %>% 
  mpa_names() %>% 
  # View()
  pivot_wider(
    names_from = stat,
    values_from = value # or = first, max, etc.
  ) %>% 
  # Z-score is a statistical measure that quantifies the distance between a data point and the mean of a dataset. It's expressed in terms of standard deviations.
  mutate(
    z_score = mean_esm / sd_esm,
    confidence_flag = case_when(
      abs(z_score) > 2 ~ "high",
      abs(z_score) > 1 ~ "moderate",
      TRUE ~ "low"
    ),
    pos = ifelse(ssp == "SSP1-2.6", 3.5,4.5)
  ) %>% 
  # View()
  # Check confident n
  group_by(confidence_flag) %>%
  mutate(n_conf = round((n()/64)*100)) %>%
  View()
ggplot() +
  geom_bar(
    aes(
      x = reorder(region,mean_esm),
      y = mean_esm,
      fill = ssp
    ),
    stat = "identity",
    position = "dodge"
  ) +
  geom_errorbar(
    aes(
      x = reorder(region,mean_esm),
      ymin = mean_esm - sd_esm,
      ymax = mean_esm + sd_esm,
      color = ssp
    ),
    position = "dodge",
    stat = "identity",
    linetype = "longdash",
    alpha = 0.5,
    width = 0.5
  ) +
  geom_point(
    aes(
      x = reorder(region,mean_esm),
      y = pos,
      color = ssp,
      shape = confidence_flag
    ),
    position = "dodge",
    size = 1
  ) +
  facet_wrap(~period,
             scales = "free_x"
  ) +
  scale_fill_manual("Climate change scenario",
                    values = c(wes_palette("Zissou1",type = "discrete")[1],
                               wes_palette("Zissou1",type = "discrete")[5]
                    )
                    
  ) +
  scale_color_manual("Climate change scenario",
                     values = c(wes_palette("Zissou1",type = "discrete")[1],
                                wes_palette("Zissou1",type = "discrete")[5]
                     )
  ) +
  scale_shape_discrete("Confidence level") +
  coord_flip() +
  labs(x="",
       y = "Change in biomass relative to baseline (%)")+
  my_ggtheme_p(leg_pos = "right") +
  scale_y_continuous(
    limits = c(-30,5),
    breaks = seq(-30,10,5),
    expand = c(0,0)
  ) + 
  theme(
    panel.spacing = unit(2, "lines")
  )

ggsave(
  paste0(results_path,"figures/relative_hist/all/sq_relative_historic_regional.png"),
  last_plot(),,
  height = 6,
  width = 8
)


# confidence_flag
# high	59 %
# low	17%
# moderate	23%



```


## Fig. 4 Relative to SQ (Delta Delta)

Note that this step requires the preivous one and the usage of `dif_2040sq` or `dif_2040` will impact the results.

```{r}

data_df_sq <- data_df %>% 
  pivot_wider(names_from = scen, values_from = value) %>% 
  gather("scen","value",nr:rp) %>% 
  mutate(dif_per = value-sq
  ) %>% 
  scenario_names(leng = "eng") %>% 
  # View()
  mpa_names() %>% 
  # View()
  select(region,ssp,period,scenario,dif_per,stat) %>% 
  pivot_wider(
    names_from = stat,
    values_from = dif_per
  ) %>% 
  filter(
    region != "High seas"
  )

data_df_sq %>% 
  ggplot() +
  geom_bar(
    aes(
      x = reorder(region,desc(region)),
      y = mean_esm,
      fill = ssp
    ),
    stat = "identity",
    position = "dodge"
  ) +
  geom_errorbar(
    aes(
      x = reorder(region,desc(region)),
      ymin = mean_esm - sd_esm,
      ymax = mean_esm + sd_esm,
      color = ssp
    ),
    position = "dodge",
    stat = "identity",
    linetype = "longdash",
    alpha = 0.5,
    width = 0.5
  ) +
  geom_vline(
    xintercept = 0,
    linetype = "dashed",
    color = "grey"
  ) +
  # geom_point(
  #            aes(
  #              x = reorder(region,mean_esm),
  #              y = pos,
  #              color = ssp,
  #              shape = confidence_flag
  #            ),
  #            position = "dodge",
  #            size = 1
  # ) +
  facet_grid2(
    period ~ scenario,
    scales = "free_x"
  )+
  scale_fill_manual("Climate change\nscenario",
                    values = c(wes_palette("Zissou1",type = "discrete")[1],
                               wes_palette("Zissou1",type = "discrete")[5]
                    )
                    
  ) +
  scale_color_manual("Climate change\nscenario",
                     values = c(wes_palette("Zissou1",type = "discrete")[1],
                                wes_palette("Zissou1",type = "discrete")[5]
                     )
  ) +
  scale_shape_discrete("Confidence level") +
  coord_flip() +
  labs(x="",
       y = "Difference in biomass change relative to status quo (%)")+
  my_ggtheme_p(
    leg_pos = "right",
    facet_tx_s = 13,
    ax_tl_s = 14,
    ax_tx_s = 12,
    leg_tl_s = 14,
    leg_tx_s = 12
  ) +
  scale_y_continuous(
    expand = c(0,0)
  )  

ggsave(
  paste0(results_path,"/figures/relative_scen/all/","sq_relative_barplot.png"),
  last_plot(),
  height = 7,
  width = 14
)

```


```{r}
data_df_sq %>% 
  select(-sd_esm) %>% 
  filter(
    scenario %in% c("Regulations for conservation","Regulations for fishing")
  ) %>% 
  spread(scenario,mean_esm) %>% 
  mutate(
    flag_larger = ifelse(
      `Regulations for conservation` > `Regulations for fishing`,
      "Conservation",
      "Fishing"
    ),
    # how much highwer
    dif_per = abs(`Regulations for conservation` - `Regulations for fishing`),
  ) %>% 
  View()
```

# Exploration

## Level of Biomass

### Absolute ranking

```{r}

abs_rank <- scenarios_data_abs %>% 
  # filter(
    # region %in% c("Galapagos Isl. (Ecuador)","Galapagos_Ecuador")
  # ) %>% 
  mutate(
    time_frame = case_when(
      # year > 1994 & year < 2014 ~ "historic",
      year < 2015 ~ "2014",
      year > 2021 & year < 2040 ~ "2030",
      year > 2041 & year < 2060 ~ "2050",
      TRUE ~ NA_character_
    )
  ) %>% 
  filter(!is.na(time_frame)) %>% 
  group_by(region,scen,esm,ssp,time_frame) %>%
  summarise(mean_time = mean(value_region, na.rm = T)) %>% 
  # mean ESMS
  group_by(region,scen,ssp,time_frame) %>%
  summarise(mean_esm = mean(mean_time, na.rm = T)) %>% 
  group_by(region, ssp, time_frame) %>%
  arrange(desc(mean_esm), .by_group = TRUE) %>%
  mutate(rank = row_number()) %>%
  ungroup() %>% 
  mutate(
    labels = case_when(
      rank == 1 ~ 5,
      rank == 2 ~ 4,
      rank == 3 ~ 3,
      rank == 4 ~ 2,
      rank == 5 ~ 1
    )
  ) 

abs_rank %>% 
  scenario_names(leng = "eng") %>%
  mpa_names() %>%
  ggplot() +
  geom_bar(
    aes(
      x = reorder(scen,labels),
      y = as.character(labels),
      fill = time_frame
    ), stat = "identity",
    position = "dodge"
  ) +
  scale_y_discrete(
    labels = c("5" = "1",
               "4" = "2",
               "3" = "3",
               "2" = "4",
               "1" = "5")
  ) +
  # facet_wrap(ssp~region, 
  #            nrow = 5) +
  facet_wrap(ssp ~ region, nrow = 5,
           labeller = labeller(
             ssp = function(x) "",
             region = label_value
           ),
           strip.position = "top") +
  labs(
    x = "Management Scenario",
    y = "Biomass ranking across scenarios (1 = highest biomass)"
  ) +
  my_ggtheme_p(
    leg_pos = "right",
    leg_tx_s = 10,
    leg_tl_s = 11,
    ax_tx_s = 10,
    ax_tl_s = 11,
    # axx_tx_ang = 90,
    facet_tx_s = 12,
    x_hjust = 0.5
  ) +
  scale_fill_viridis_d("Time frame")


ggsave(
  paste0(results_path,"/supplements/","biomass_ranking.png"),
  last_plot(),
  height = 7,
  width = 14
)


```

### Minus delta

```{r}

minus_delta <- scenarios_data_abs %>% 
  mutate(
    time_frame = case_when(
      # year > 1994 & year < 2014 ~ "historic",
      year < 2015 ~ "historic",
      year > 2021 & year < 2040 ~ "early_2030",
      year > 2041 & year < 2060 ~ "mid_2050",
      TRUE ~ NA_character_
    )
  ) %>% 
  filter(!is.na(time_frame)) %>% 
  group_by(region,scen,esm,ssp,time_frame) %>%
  summarise(mean_time = mean(value_region, na.rm = T)) %>% 
  group_by(region,scen,ssp,time_frame) %>% 
  pivot_wider(names_from = time_frame, values_from = mean_time) %>% 
  # left_join(sq_df) %>% 
  mutate(
    dif_2030 = early_2030,historic,
    dif_2050 = mid_2050,historic
  )
  scenario_names(leng = "eng") %>% 
  # filter(!is.na(dif_2040)) %>% 
  # filter(region != "High seas") %>% 
  summarise(
    across(
      c(dif_2030, dif_2050),
      list(mean_esm = ~mean(.x, na.rm = TRUE),
           sd_esm = ~sd(.x, na.rm = TRUE)),
      .names = "{.col}_{.fn}"
    ),
    .groups = "drop"
  ) %>% 
  pivot_longer(cols = c("dif_2030_mean_esm": "dif_2050_sd_esm"),
               names_to = "period",
               values_to = "value") %>% 
  mutate(
    stat = ifelse(str_detect(period, "mean"), "mean_esm", "sd_esm"),
    period = ifelse(str_detect(period, "2030"), "2030", "2050"),
    ssp = ifelse(ssp == "ssp126", "SSP1-2.6","SSP5-8.5")
  )


```


## Galapagos

```{r}

data_df %>% 
  filter(
    region %in% c("Galapagos Isl. (Ecuador)","Galapagos_Ecuador"),
    scen %in% c("rc","rp","ri"),
  ) %>% View()


data_gal <- scenarios_data_abs %>% 
  # filter(
    # region %in% c("Galapagos Isl. (Ecuador)","Galapagos_Ecuador")
  # ) %>% 
  mutate(
    time_frame = case_when(
      # year > 1994 & year < 2014 ~ "historic",
      year < 2015 ~ "historic",
      year > 2021 & year < 2040 ~ "early_2030",
      year > 2041 & year < 2060 ~ "mid_2050",
      TRUE ~ NA_character_
    )
  ) %>% 
  filter(!is.na(time_frame)) %>% 
  group_by(region,scen,esm,ssp,time_frame) %>%
  summarise(mean_time = mean(value_region, na.rm = T)) %>% 
  # group_by(region,scen,ssp,time_frame) %>%
  pivot_wider(names_from = scen, values_from = mean_time) %>%
  # Uncomment To understand who has more biomass in all cases
  # group_by(region, esm, ssp, time_frame) %>%
  # arrange(desc(mean_time), .by_group = TRUE) %>%
  # mutate(rank = row_number()) %>%
  # ungroup() %>% 
  # filter(rank == 1)
  # ----------- #

  # left_join(sq_df) %>% 
  mutate(
    dif_2030 = my_chng(historic,early_2030),
    dif_2050 = my_chng(historic,mid_2050),
    # dif_2040sq = my_chng(mean_esm,early_2050),
  )
  summarise(
    across(
      c(dif_2030, dif_2050),
      list(mean_esm = ~mean(.x, na.rm = TRUE),
           sd_esm = ~sd(.x, na.rm = TRUE)),
      .names = "{.col}_{.fn}"
    ),
    .groups = "drop"
  ) %>% 
  pivot_longer(cols = c("dif_2030_mean_esm": "dif_2050_sd_esm"),
               names_to = "period",
               values_to = "value") %>% 
  mutate(
    stat = ifelse(str_detect(period, "mean"), "mean_esm", "sd_esm"),
    period = ifelse(str_detect(period, "2030"), "2030", "2050"),
    ssp = ifelse(ssp == "ssp126", "SSP1-2.6","SSP5-8.5")
  )

```


## Fig. Protected v.s. not protected

```{r}


gridded_data <- read_csv(paste0(data_path,"04 raw dbem results/processed/all/all_years_data_abd_esm_gridded.csv"))

grid_path <- paste0(data_path,"01 spatial/gridded/all_mpa_grid_fe.csv")

mpas_grid <- read_csv(grid_path) %>% 
  rename(mpa_abrev = mpa) %>% 
  distinct()

cmar_grid <- my_data("dbem_coords") %>% 
  filter(lat < 10 & lat > -10 & lon > -100 & lon < -70) %>% 
  left_join(mpas_grid) %>% 
  left_join(my_data("sau_index")) %>% 
  mutate(status = ifelse(is.na(status),"non_protected",status),
         region = ifelse(is.na(mpa_abrev),eez_name,mpa_abrev)
  ) %>% 
  filter(!region %in% c("Colombia (Caribbean)","Panama (Caribbean)","Costa Rica (Caribbean)","El Salvador","Nicaragua (Pacific)","Peru","Venezuela"),
         !is.na(eez_name))

gridded_df <- gridded_data %>% 
  left_join(cmar_grid) %>% 
  # group_by(year,status,region,scen,ssp,esm) %>%
  # summarise(sum = sum(value_region, na.rm = T),
  #           .groups = "drop"
  # ) %>%  
  mutate(
    time_frame = case_when(
      # year > 1994 & year < 2014 ~ "historic",
      year < 2015 ~ "historic",
      year > 2021 & year < 2040 ~ "early_2030",
      year > 2041 & year < 2060 ~ "mid_2050",
      TRUE ~ NA_character_
    )
  ) %>% 
  filter(!is.na(time_frame)) %>% 
  group_by(status,region,scen,esm,ssp,time_frame,index) %>%
  summarise(mean_time = mean(value_region, na.rm = T)) %>% 
  group_by(status,region,scen,ssp,time_frame,index) %>%
  summarise(mean_time = mean(mean_time, na.rm = T)) %>% 
  # group_by(status,region,scen,ssp,time_frame,index) %>%
  # summarise(mean_time = mean(mean_time, na.rm = T))
  # group_by(status,region,scen,ssp,time_frame) %>% 
  pivot_wider(names_from = time_frame, values_from = mean_time) %>% 
  # left_join(sq_df) %>% 
  mutate(
    dif_2030 = my_chng(historic,early_2030),
    dif_2050 = my_chng(historic,mid_2050)
  ) %>% 
  scenario_names(leng = "eng")
  # filter(!is.na(dif_2040)) %>% 
  # filter(region != "High seas") %>% 
  # summarise(
  #   across(
  #     c(dif_2030, dif_2050),
  #     list(mean_esm = ~mean(.x, na.rm = TRUE),
  #          sd_esm = ~sd(.x, na.rm = TRUE)),
  #     .names = "{.col}_{.fn}"
  #   ),
  #   .groups = "drop"
  # )# 
  # pivot_longer(cols = c("dif_2030_mean_esm": "dif_2050_sd_esm"),
  #              names_to = "period",
  #              values_to = "value") %>% 
  # mutate(
    # stat = ifelse(str_detect(period, "mean"), "mean_esm", "sd_esm"),
    # period = ifelse(str_detect(period, "2030"), "2030", "2050"),
    # ssp = ifelse(ssp == "ssp126", "SSP1-2.6","SSP5-8.5")
  # )



gridded_data_df_sq <- gridded_df %>% 
  select(status,region,scen,ssp,index,dif_2030,dif_2050) %>% 
  pivot_longer(
    cols = c("dif_2030","dif_2050"),
    names_to = "period",
    values_to = "value"
  ) %>% 
  pivot_wider(names_from = scen, values_from = value) %>% 
  gather("scen","value",nr:ri) %>% 
  mutate(dif_per = value-sq) %>% 
  scenario_names(leng = "eng")

```

```{r}

gridded_data_df_sq %>% 
  # filter(scen == "sq") %>% 
    mutate(
      eez = ifelse(str_detect(region,"Panama"),"Panama",
                         ifelse(str_detect(region,"Colombia"),"Colombia",
                                ifelse(str_detect(region,"Cuenca"),"Colombia",
                                       ifelse(str_detect(region,"Gorgona"),"Colombia",
                                ifelse(str_detect(region,"Costa"),"Costa Rica",
                                       ifelse(str_detect(region,"Ecuador"),"Ecuador","High seas"
                                       )
                                )
                         )
                                )
                         )
      )
  ) %>%
  filter(eez != "High seas") %>%
  # View()
ggplot() +
  geom_boxplot(
    aes(
      x = eez,
      y = dif_per,
      fill = scenario
    ),
    position = "dodge"
  ) +
  # facet_wrap2(
  #   ~ ssp,
  #   ncol = 1,
  #   scales = "free_x"
  # )
  facet_grid(
    ssp ~ status
  ) +
  theme_classic()+
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  geom_hline(
    yintercept = 0,
    linetype = "dashed",
    color = "grey"
  )  +
  scale_fill_viridis_d("Management scenario")


ggsave(
  paste0(results_path,"figures/relative_scen/grid/sq_relative_boxplot.png"),
  last_plot(),
  height = 7,
  width = 14
)
```

### Differences between protection

```{r}

scenarios <- read_csv(paste0(data_path,"01 spatial/gridded/all_mpa_grid_fe.csv")) 

gridded_data_df_sq %>% 
  filter(status == "protected") %>% 
  left_join(scenarios,
            by ="index") %>%
  ggplot() +
  geom_point(
    aes(
      x = value,
      y = fe_prop
    ),
    position = "dodge",
    size = 1
  ) 
  
  
```


## Fig. Groups

### Data prep

```{r}
list_groups <- list.files(paste0(data_path,"04 raw dbem results/processed/groups/"),full.names = T)
list_groups <- list_groups[grep("abd", list_groups)]



scenarios_data_groups <- 
  bind_rows(
    lapply(list_groups, read_csv)
  )

group_df<- scenarios_data_groups %>% 
  select(-sd_value_esm) %>% 
  pivot_wider(names_from = period, values_from = mean_value_esm) %>% 
  mutate(
    dif_2030 = my_chng(`2014_hist`,`2030_ear`),
    dif_2050 = my_chng(`2014_hist`,`2050_mid`)
  ) %>% 
  gather("period","diff_change",`dif_2030`:`dif_2050`) %>% 
  select(scen,region,ssp,group,period,diff_change) %>% 
  pivot_wider(names_from = scen, values_from = diff_change) %>% 
  gather("scenario","value",nr:rp) %>% 
  mutate(dif_per = value-sq) %>% 
  mpa_names() %>% 
  select(region:period,scen = scenario,dif_per) %>% 
  scenario_names(leng = "eng") %>% 
  mutate(
    group = case_when(
      group == "atunes" ~ "Tuna",
      group == "dorado" ~ "Mahi-mahi",
      group == "invertebrados" ~ "Invertebrates",
      group == "jureles" ~ "Mackerels",
      group == "meros" ~ "Snappers",
      group == "others" ~ "Others",
      group == "pequeños_pelagicos" ~ "Small pelagics",
      group == "picudos" ~ "Billfishes",
      group == "tiburones" ~ "Sharks",
      TRUE ~ NA_character_
    )
  )

# unique(group_df$group)
```


```{r}

group_df %>% 
  filter(ssp =="ssp585",
         period == "dif_2050") %>% 
  # View()
  ggplot() +
  geom_bar(
    aes(
      x = reorder(region,desc(region)),
      y = dif_per,
      fill = scenario
    ),
    stat = "identity",
    position = "dodge"
  ) +
  geom_vline(
    xintercept = 0,
    linetype = "dashed",
    color = "grey"
  ) +
  facet_wrap2(
    ~ group,
    ncol = 3,
    scales = "free_x"
  )+
  scale_fill_viridis_d("Management scenario") +
  coord_flip() +
  labs(x="",
       y = "Difference in biomass change relative to status quo (%)")+
  my_ggtheme_p(
    leg_pos = "right",
    facet_tx_s = 13,
    ax_tl_s = 14,
    ax_tx_s = 12,
    leg_tl_s = 14,
    leg_tx_s = 12
  ) +
  scale_y_continuous(
    expand = c(0,0)
  )  + 
  theme(
    panel.spacing = unit(2, "lines")
  )


ggsave(
  # paste0(results_path,"figures/relative_scen/groups/sq_relative_barplot_126_2030.png"),
  # paste0(results_path,"figures/relative_scen/groups/sq_relative_barplot_126_2050.png"),
  # paste0(results_path,"figures/relative_scen/groups/sq_relative_barplot_585_2030.png"),
  paste0(results_path,"figures/relative_scen/groups/sq_relative_barplot_585_2050.png"),
  last_plot(),
  height =10,
  width = 12
)

```


## Statistical analysis


#### Permutation-based linear model

```{r}

stats_data %>% 
  gather("variable","test",area_km2,lat,fe) %>% 
ggplot(
       aes(value, test)) +
  geom_point() +
  geom_smooth(method = "loess") +
  facet_wrap(ssp ~ variable +scen, scales = "free")

```

# GAM

```{r}

cmar_grid <-
  read.csv("~/Library/CloudStorage/GoogleDrive-jepa88@gmail.com/My Drive/lenfest_mpa_project/data/01 spatial/gridded/all_mpa_grid_fe.csv") %>% 
  select(-fe_prop)


management_scen <- list.files("~/Library/CloudStorage/GoogleDrive-jepa88@gmail.com/My Drive/lenfest_mpa_project/data/01 spatial/compute_canada/", full.names = T)

fe_data <- bind_cols(
lapply(management_scen, read.table, quote="\"", comment.char="")
)

colnames(fe_data) <- c("nr","ri","rpc","rpp","sq")

fe_data <-
  fe_data %>% 
  rowid_to_column("index") %>% 
  right_join(cmar_grid, by = "index") %>% 
  pivot_longer(
    cols = c("nr","ri","rpc","rpp","sq"),
    names_to = "scen",
    values_to = "fe_prop"
  ) %>% 
  group_by(region = mpa,scen) %>%
  # View()
  summarise(
    fe = mean(fe_prop, na.rm = T)
  ) %>% 
  #Change names to match 
  mutate(
    scen = case_when(
      scen == "nr" ~ "nr",
      scen == "ri" ~ "ri",
      scen == "rpc" ~ "rc",
      scen == "rpp" ~ "rp",
      scen == "sq" ~ "sq"
    )
  )


stats_data <- cmar_sf %>% #cmar_sf_size
  mutate(area_m2 = st_area(geometry),
         area_km2 = as.numeric(st_area(geometry)) / 1e6,
         centroid = st_centroid(geometry),        # compute centroid
    lon = st_coordinates(centroid)[,1],     # extract longitude
    lat = st_coordinates(centroid)[,2]) %>% 
  as.data.frame() %>% 
  select(region,area_km2,lat) %>%
  left_join(data_df) %>%
  filter(stat == "mean_esm") %>% 
  left_join(fe_data, by = c("region", "scen"))

# write_csv(stats_data, paste0(results_path,"stats_data.csv"))

```

## Check for normality

```{r}

# ggplot2 histogram
ggplot(stats_data, aes(x = value)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Histogram of Value", x = "Value", y = "Frequency") +
  theme_minimal() +
  facet_grid(ssp ~ period)

# shapiro test per period and ssp
stats_data %>%
  group_by(ssp, period) %>%
  summarise(
    shapiro_result = list(shapiro.test(value)),
    W = shapiro_result[[1]]$statistic,
    p_value = shapiro_result[[1]]$p.value
  ) %>%
  select(ssp, period, W, p_value)

# SSP1-2.6	2030	0.9852526	0.7824097	
# SSP1-2.6	2050	0.9786990	0.4984939	
# SSP5-8.5	2030	0.9821579	0.6458377	
# SSP5-8.5	2050	0.9752006	0.3714282	

# Interpretation:
# In all cases, the p-values are greater than 0.05, indicating that we fail to reject the null hypothesis of normality.


# 1. Compute Shapiro statistics
stats_summary <- stats_data %>%
  group_by(ssp, period,scen) %>%
  summarise(
    shapiro = list(shapiro.test(value)),
    W = shapiro[[1]]$statistic,
    p = shapiro[[1]]$p.value,
    .groups = "drop"
  ) %>%
  mutate(
    facet_label = str_glue("{scen}, {ssp}, {period}\nW = {round(W, 3)}, p = {round(p, 3)}")
  )

# 2. Join back to original data and plot with facet labels
stats_data %>%
  left_join(stats_summary, by = c("ssp", "period")) %>% 
  ggplot(aes(x = value)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black", alpha = 0.7) +
  facet_wrap(~ facet_label, ncol = 4) +
  labs(
    # title = "Histogram of Value with Shapiro-Wilk Statistics",
       x = "Value", y = "Frequency") +
  # theme_minimal()
  my_ggtheme_p()

ggsave(
  paste0(results_path,"figures/relative_hist/all/shapiro_histograms.png"),
  last_plot(),
  height = 8,
  width = 10
)



```


## Check linearlity

Previous analysis suggests that we have non-linearity in the data, mostly on area and maybe latitude. So I'll test that to pass it to the final GAM as a smooth (s()) term.

Result: ONly area should be smoothed.


<!-- we compared nested GAMs with linear and spline terms using an annova test. Introducing a smooth for area_km2 substantially improved model fit (ΔDeviance = 447.1, F = 23.05, p < 2 × 10⁻¹⁶), while smoothing latitude did not improve fit (F = 1.94, p = 0.15). -->




```{r}
m1 <- gam(value ~ lat + area_km2 + ssp + scen + period, data = stats_data)

m2 <- gam(value ~ lat + s(area_km2) + ssp + scen + period, data = stats_data)

m3 <- gam(value ~ s(lat) + s(area_km2) + ssp + scen + period, data = stats_data)

anova(m1, m2, m3,test = "F")
```
## Model

```{r}


mod_spline <- gam(
  value ~ lat + s(area_km2) + ssp + scen  + period,
  data = stats_data
)

summary(mod_spline)
# plot(mod_spline, pages = 1)


```

## Model output

```{r}

# Linear and smooth terms
tidy_linear <- tidy(mod_spline, parametric = TRUE)
tidy_smooth <- tidy(mod_spline, parametric = FALSE)

# Combine for a full table
tidy_full <- bind_rows(tidy_linear, tidy_smooth)
tidy_full


library(sjPlot)

# Table for linear terms
tab_model(mod_spline, show.se = TRUE, show.stat = TRUE, show.p = TRUE)
```

## Model diagnostics

```{r}
# Add predictions
stats_data$pred <- predict(mod_spline)

ggplot(stats_data, aes(x = pred, y = value)) +
  geom_point(alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  labs(x = "Predicted", y = "Observed", title = "GAM: Observed vs Predicted")

# Example for scenario effect
coef_scen <- coef(mod_spline)[grep("scen", names(coef(mod_spline)))]
df <- data.frame(scenario = names(coef_scen), estimate = coef_scen)
ggplot(df, aes(x = scenario, y = estimate)) +
    geom_col(fill = "steelblue") +
    labs(y = "Effect on value", x = "Scenario")



# 1. Smooth term plot for area_km2
p1 <- draw(mod_spline, select = "s(area_km2)") +
      # ggtitle("Effect of Area (km²) on Value") +
  ggtitle("C") +
      my_ggtheme_p()

# 2. Categorical/linear effects plot (ssp, scen, period, lat)
# Extract parametric coefficients
coefs <- summary(mod_spline)$p.table
# Keep only predictors of interest
coefs_df <- as.data.frame(coefs)
coefs_df$term <- rownames(coefs_df)
coefs_df <- coefs_df[!grepl("(Intercept)", coefs_df$term), ]
# Plot estimates
p2 <- ggplot(coefs_df, aes(x = reorder(term, Estimate), y = Estimate)) +
      geom_point(size = 3, color = "steelblue") +
      geom_errorbar(aes(ymin = Estimate - `Std. Error`, ymax = Estimate + `Std. Error`), width = 0.2) +
      coord_flip() +
      # labs(y = "Estimated Effect", x = "", title = "Linear Effects") +
  labs(y = "Estimated Effect", x = "", title = "B") +
      my_ggtheme_p()

# 3. Observed vs Predicted plot
stats_data$pred <- predict(mod_spline)
p3 <- ggplot(stats_data, aes(x = pred, y = value)) +
      geom_point(alpha = 0.5) +
      geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
      # labs(x = "Predicted Value", y = "Observed Value", title = "Observed vs Predicted") +
  labs(x = "Predicted Value", y = "Observed Value", title = "A") +
      my_ggtheme_p()

# Combine panels
p3 / p2 / p1 + plot_layout(nrow = 3)

ggsave(
  paste0(results_path,"figures/relative_hist/all/gam_diagnostics.png"),
  last_plot(),
  height = 6,
  width = 8
)

# Figure caption: 

```




# Old code

```{r}
#plot function
map_fx <- function(data, period_selected, ssp_selected){
  
  data_plot <- data %>% 
    filter(ssp == ssp_selected,
           period == period_selected)
  
  min_n <- round(min(data_plot$perchange,na.rm = T))-1
  max_n <- round(max(data_plot$perchange,na.rm = T))+1
  mid_n <- 0
  breaks_n <- pretty(c(min_n, max_n), n = 5)
  
  
  plot_name <- paste0(results_path,"figures/relative_hist/all/",period_selected,"_relative_historic_",ssp_selected,".png")
  # ----------- #
  
  map <-
    ggplot() +
    geom_sf(data = sau_sf %>% select(region = name) %>%  left_join(data_plot),
            aes(fill = perchange),
            color = "grey"
    ) +
    geom_sf(data = cmar_sf %>%  left_join(data_plot),
            aes(fill = perchange),
            color = "black"
    ) +
    facet_wrap(~scenario) +
    scale_fill_gradient2("Change in biomass by 2050\nrelative to baseline (%)",
                         limits = c(min_n,max_n),
                         breaks = breaks_n
    ) +
    theme(
      title = element_text(size = 4),
      legend.background = element_rect(color = "grey",linewidth = 0.5,linetype = "solid"
      )
    )  +
    my_ggtheme_m("Reg",
                 facet_tl_s = 10,
                 ax_tl_s = 10,
                 ax_tx_s = 10,
                 leg_tl_s = 2,
                 leg_tx_s = 1,
                 leg_pos = c(0.83, 0.25)) +
    guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5, title.vjust = 0.5))  
  
  
  
  ggsave(
    plot_name,
    map,
    height = 6,
    width = 8
  )
  
}

# DO NOT MODIFY
map_fx(
  data = data_df,
  ssp_selected =  "ssp585",
  period_selected = "dif_2050"
)

```


## Fig 3A. Relative to historic period (period)

```{r}

sq_data <- data_df %>% 
  filter(scen == "sq") %>% 
  scenario_names(leng = "eng") %>% 
  spread(stat,value) %>% 
  mutate(
    z_score = mean_esm / sd_esm,
    confidence_flag = case_when(
      abs(z_score) > 2 ~ "high",
      abs(z_score) > 1 ~ "moderate",
      TRUE ~ "low"
    )
  )

# Confidence
sau_points_sf <-
  sau_sf %>%
  rename(region = name) %>% 
  left_join(sq_data) %>%
  select(region:scenario,confidence_flag) %>%
  st_centroid()

# Confidence
cmar_points_sf <-
  cmar_sf %>%
  left_join(sq_data) %>%
  select(region:scenario,confidence_flag) %>%
  st_centroid()


map <-
  ggplot() +
  geom_sf(data = sau_sf %>% select(region = name) %>%  left_join(sq_data),
          aes(fill = mean_esm),
          color = "grey"
  ) +
  geom_sf(data = cmar_sf %>%  left_join(sq_data),
          aes(fill = mean_esm),
          color = "black"
  ) +
  geom_sf(data = sau_points_sf,
          aes(shape = confidence_flag)
  ) +
  geom_sf(data = cmar_points_sf,
          aes(shape = confidence_flag)
  ) +
  facet_grid(ssp~period) +
  # For SQ scenario change
  scale_fill_gradient2("Change in biomass\nrelative to baseline (%)",
                       limits = c(-15,1),
                       breaks = seq(-15,1,5)
  ) +
  my_land_map() +
  my_ggtheme_m("Reg",
               facet_tl_s = 10,
               ax_tl_s = 8,
               ax_tx_s = 8,
               leg_tl_s = 8,
               leg_tx_s = 8,
               leg_pos = "right" 
  ) +
  # theme(
  # legend.key.width = unit(3, "line"),
  # title = element_text(size = 4)
  # )  +
  # guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5)
  # ) +
  coord_sf(
    xlim = c(-95,-77),
    ylim = c(-5,9)
  )


ggsave(
  paste0(results_path,"figures/relative_hist/all/aaaaasq_relative_map.png"),
  # paste0(results_path,"figures/relative_scen/all/ssp126_sq_relative_map.png"),
  map,
  height = 7,
  width = 8
)


```
## Fig. 5A Relative to SQ (Delta Delta)

Note that this step requires the preivous one and the usage of `dif_2040sq` or `dif_2040` will impact the results.

```{r}

data_df_sq <- data_df %>% 
  filter(stat == "mean_esm") %>% 
  pivot_wider(names_from = scen, values_from = value) %>% 
  gather("scen","value",nr:rp) %>% 
  mutate(dif_per = value-sq) %>% 
  scenario_names(leng = "eng") %>% 
  filter(
    # ssp == "SSP1-2.6"
    # ssp == "SSP5-8.5"
    period == 2030
    # period == 2050
  )

map <-
  ggplot() +
  geom_sf(data = sau_sf %>% select(region = name) %>%  left_join(data_df_sq),
          aes(fill = dif_per),
          color = "grey"
  ) +
  geom_sf(data = cmar_sf %>%  left_join(data_df_sq),
          aes(fill = dif_per),
          color = "black"
  ) +
  facet_grid(ssp~scenario) +
  # For SQ scenario change
  scale_fill_gradient2("Differnce in biomass change rlative to status quo (%)",
                       # limits = c(-2,10),
                       # breaks = seq(-2,10,2)
                       # limits = c(-6,6), # for ssp-585
                       # breaks = seq(-2,2,1) # for ssp-585
  ) +
  my_ggtheme_m("Reg",
               facet_tl_s = 10,
               ax_tl_s = 8,
               ax_tx_s = 8,
               leg_tl_s = 8,
               leg_tx_s = 8) +
  theme(
    legend.key.width = unit(3, "line"),
    title = element_text(size = 4)
  )  +
  guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5))


ggsave(
  # paste0(results_path,"figures/relative_scen/all/ssp585_sq_relative_map.png"),
  # paste0(results_path,"figures/relative_scen/all/ssp126_sq_relative_map.png"),
  paste0(results_path,"figures/relative_scen/all/2030_sq_relative_map.png"),
  # paste0(results_path,"figures/relative_scen/all/2050_sq_relative_map.png"),
  map,
  height = 6,
  width = 10
)
```



### Normal

### Size info

```{r}

library(broom) # for tidy lm outputs
library(ggpubr) #for stat_regline_equation



# Add a new column with the area in km² (or m² depending on CRS)
cmar_sf_size <- cmar_sf %>%
  mutate(area_m2 = st_area(geometry),
         area_km2 = as.numeric(st_area(geometry)) / 1e6,
         centroid = st_centroid(geometry),        # compute centroid
    lon = st_coordinates(centroid)[,1],     # extract longitude
    lat = st_coordinates(centroid)[,2]) %>% 
  as.data.frame() %>% 
  select(region,area_km2,lat) %>%
  left_join(data_df) %>% 
  filter(stat == "mean_esm",
         scen == "sq") 


# Check for co-linearity between latitutde and size
# Keep unique region values to avoid repeated rows
unique_regions <- cmar_sf_size %>%
  select(region, area_km2, lat) %>%
  distinct()

# Correlation Pearson's
cor(unique_regions$lat, unique_regions$area_km2) # -0.6401246


# Latitude plot
cmar_sf_size %>% 
  ggplot(aes(
      y = lat,
      x = value,
      color = region
    )) +
  geom_point(
    size = 2,
    alpha = 0.7
  ) +
  geom_smooth(data = cmar_sf_size,
              aes(
                y = lat,
                x = value,
                color = region
              ),
              method = "lm",
              se = T, 
              color = "black") +  # lm line
  facet_grid(ssp~period,
             scales = "free_x")  +
  labs(
    y = "Latitud",
    x = "Biomass change relative to baseline (%)",
    color = "Region"
  ) +
  # Show stats
  geom_text(
    data = size_stats,
    aes(y = 10,
        x = min(cmar_sf_size$value),
        label = paste0("P = ",round(p.value,2),", R² = ", round(r.squared*100, 2))),
    inherit.aes = FALSE,
    hjust = 0,
    vjust = 1,
    size = 3
  ) +
  theme_minimal()


# Size plot

size_stats <- cmar_sf_size %>% 
  group_by(scen, period, ssp) %>%
  do(model = lm(value ~ area_km2, data = .)) %>%
  mutate(glance = list(broom::glance(model))) %>%
  tidyr::unnest(glance) %>% 
  select(scen, period, ssp, r.squared, adj.r.squared, p.value)

cmar_sf_size %>% 
  ggplot(aes(
      x = area_km2,
      y = value,
      color = region
    )) +
  geom_point(
    size = 2,
    alpha = 0.7
  ) +
  geom_smooth(data = cmar_sf_size,
              aes(
                x = area_km2,
                y = value,
                color = region
              ),
              method = "lm",
              se = T, 
              color = "black") +  # lm line
  facet_grid(ssp~period,
             scales = "free_x")  +
  labs(
    x = "Area (Km2)",
    y = "Biomass change relative to baseline (%)",
    color = "Region"
  ) +
  # Show stats
  geom_text(
    data = size_stats,
    aes(x = min(cmar_sf_size$area_km2),
        y = max(cmar_sf_size$value),
        label = paste0("P = ",round(p.value,2),", R² = ", round(r.squared*100, 2))),
    inherit.aes = FALSE,
    hjust = 0,
    vjust = 1,
    size = 3
  ) +
  theme_minimal()

```

### Linear mixed model

```{r}
library(lme4)      # for mixed models
library(lmerTest)  # for p-values
library(broom.mixed) # tidy results

# ssp_test <- "SSP1-2.6"
ssp_test <- "SSP5-8.5"

mod_rc <- lm(value ~ area_km2 + lat, data = cmar_sf_size %>% 
               filter(period == "2050", ssp == ssp_test))


lmmod_rc <- lm(value ~ area_km2, data = cmar_sf_size %>% filter(ssp == ssp_test))
summary(lmmod_rc)

mod_rc <- lmer(value ~ area_km2 + lat, data = cmar_sf_size %>% filter(period == "2050",ssp == ssp_test))
summary(mod_rc)


# NOTE you need to modify cmar_sf_size data in previous chunk to allow for asll scenarios to be tested



mod_nr <- lmer(value ~ area_km2 + lat + (1 | region), data = cmar_sf_size %>% filter(scen == "nr",
                                                                                     ssp == ssp_test))
summary(mod_nr)

mod_ri <- lmer(value ~ area_km2 + lat + (1 | region), data = cmar_sf_size %>% filter(scen == "ri",
                                                                                     ssp == ssp_test))
summary(mod_ri)
mod_rp <- lmer(value ~ area_km2 + lat + (1 | region), data = cmar_sf_size%>% filter(scen == "rp",
                                                                                    ssp == ssp_test))
summary(mod_rp)
mod_sq <- lmer(value ~ area_km2 + lat + (1 | region), data = cmar_sf_size %>% filter(scen == "sq",
                                                                                     ssp == ssp_test))
summary(mod_sq)



```