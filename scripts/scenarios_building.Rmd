---
title: "Scenarios Construction"
author: "Juliano Palacios-Abrantes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

library(MyFunctions)

my_lib(
  c(
    "readxl",
    "tidyverse",
    "sf",
    "st",
    "janitor",
    # For grid estimation 
    "spatialEco", "geosphere","raster","units","matrixStats","rmapshaper", "igraph"
  )
)

# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)

select <- dplyr::select

knitr::opts_chunk$set(echo = TRUE)


# Change paths to your computer

data_path <- "~/Library/CloudStorage/GoogleDrive-jepa88@gmail.com/My Drive/lenfest_mpa_project/data/"

```

# Scenario Status quo

**i. Status Quo:** This scenario aims to represent, as accurately as possible, the current management of the region in terms of fishing and conservation. To inform this scenario, questions were asked regarding current levels of illegal fishing (if any), monitoring and surveillance of Marine Protected Areas (MPAs), fishing effort outside protected areas, and management strategies for MPAs. Participants responded based on their experience in the subject and in each protected area. This scenario was used as a starting point in the model to later compare with alternative management scenarios.


```{r}

# Load Grid data
grid_path <- paste0(data_path,"spatial/gridded/all_mpa_grid_fe.csv")
mpas_grid <- read_csv(grid_path) %>% 
  rename(mpa_abrev = mpa)

# Load Fishing effort data
scenarios <- read_excel(paste0(data_path,"spatial/scenarios_info.xlsx"))

# combined mpas
combined_sf <- read_sf(paste0(data_path,"spatial/cmar_capas/all_cmar_mpas.shp"))

# DBEM grid
dbem_grid <- my_data("dbem_coords")

unique(mpas_grid$mpa_abrev)

```
## Re-calculate fishing effort

We need to re-calculate fishing effort for the MPAs that are smaller than our grid cell. We asume that only a fraction of the grid is protected, however, given the different characteristics of each scenario, fishing mortality needs to be adjusted for such fraction. This way, we allocated fishing effort as a fraction of F_MSY (F/F_MSY) as follows:

When a gird cell is protected and the management scenario allows for fishing in the whole area then $\frac{F}{FMSY}$ = *f_scen*.where *f_scen*is the fishing effort determined at the workshop. When a gird cell is protected and the management plan restricts some level of fishing, then 

$$\frac{F}{FMSY} = (f_{prop}*f_{scen})+((1-f_{prop})*f_{out})$$
where $f_{prop}$ is the proportion of the grid that is protected by the MPA, $f_{scen}$ is the fishing effort allowed within the MPA as defined by the workshop, and $f_{out}$ is the scenario fishing level of un-protected grid cells. 

For grid cells that are surrounding an MPA, $\frac{F}{FMSY}$ = $f_{prop}*f_{out}$ to account for the often reported re-allocation of fishing effort given MPA restrictions. Finally, for all other grid cells within the EEZs of Costa Rica, Colombia, Ecuador and Panama (*unprotected*) $\frac{F}{FMSY}$ = $f_{out}$.


```{r}

sq_mpa_grid_f <- mpas_grid %>% 
  left_join(scenarios %>% filter(scen == "status_quo")) %>% 
  mutate(
    # For protected areas
    f_finale = ifelse(status == "protected" & f_plan == 1,f_scen,
                    ifelse(status == "protected" & f_plan != 1,((1-fe_prop)*f_scen)+(fe_prop*f_out),
                           ifelse(status == "surrounding",fe_prop*f_out,
                           f_scen
                           )
    )
  )
  ) %>%   
  select(-2,-6:-9,-notes) 

# Tests with these grids (see notebook page 144)
# grid parcial f 118276
# grid NO F 119702


```


## Merge MPA grid with rest of the world

Here we merged the MPA grid and create the DBEM layer for Compute Canada (CC)

#### IATTC sub-scenario

In this scenario, we assumed that the whole IATCC region is fihsed at F/FMSY = 1.3 while the rest of the world is F/FMSY = 1.

```{r iattc_fishing, eval = F}

regional_index_sq <- read.csv(paste0(data_path,"spatial/iattc_gridded.csv")) %>% 
   # filter(eez_name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador")) %>% 
  select(index) %>% 
  # mutate(rfmo_name = "IATTC") %>% 
  # bind_rows(
  # my_path("Spa","SAU/SAU_RFMO", "RFMO_Index_Code.csv", read = T)
  # ) %>% 
  # filter(rfmo_name == "IATTC") %>% 
  select(index) %>% 
  mutate(f_finale = 1.3,
         status = "unprotected",
         mpa_abrev = NA,
         scen = "status quo") %>% 
  left_join(dbem_grid)



sq_dbem_grid <- dbem_grid %>% 
  left_join(sq_mpa_grid_f,
            by ="index") %>% 
  select(index,lon,lat,status,mpa_abrev,status,scen,f_finale) %>% 
  mutate(
    # f_finale_plot = ifelse(f_finale > 1, f_finale, f_finale*-1),
    f_finale = ifelse(is.na(status) & index %in% regional_index_sq$index, 1.3,
                      ifelse(is.na(status) & ! index %in% regional_index_sq$index,1, f_finale)
    )
  ) %>% 
  distinct(index, .keep_all = T)
  


# Wirte grid for compute canada
sq_dbem_grid %>% 
  select(f_finale) %>% 
  write.table(file = paste0(data_path,"spatial/compute_canada/mpa_sq.txt"),
              sep="\t", col.names = F, row.names = F)

```

## EEZs sub scenario

In this scenario, we assumed that the rest of the ETP EEZs are fished at F/FMSY = 1.3 while the rest of the world is F/FMSY = 1, including the reion's high seas under the assumption that ICCAT has proper managmeent of the region

```{r, etp_eez_fishing, eval = T}

etp_eez_index_sq <- my_data("sau_index") %>% 
   filter(eez_name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador")) %>% 
  select(index) %>% 
  filter(!index %in% sq_mpa_grid_f$index) %>% 
  # mutate(rfmo_name = "IATTC") %>% 
  mutate(f_finale = 1.3,
         status = "unprotected",
         mpa_abrev = NA,
         scen = "status quo")# %>% 
  # left_join(dbem_grid)

etp_eez_index_sq


# ggplot(etp_eez_index_sq) + 
#   geom_tile(
#     aes(
#       x = lon,
#       y = lat,
#       fill = "status"
#     )
#   )

sq_dbem_grid <- dbem_grid %>% 
  left_join(sq_mpa_grid_f,
            by ="index") %>% 
  select(index,lon,lat,status,mpa_abrev,status,scen,f_finale) %>% 
  mutate(
    # f_finale_plot = ifelse(f_finale > 1, f_finale, f_finale*-1),
    f_finale = ifelse(is.na(status) & index %in% etp_eez_index_sq$index, 1.3,
                      ifelse(is.na(status) & ! index %in% etp_eez_index_sq$index,1, f_finale)
    )
  ) %>%
  distinct(index, .keep_all = T)

# sq_dbem_grid %>% 
#   filter(!is.na(status)) %>% 
#   View()


# Wirte grid for compute canada
sq_dbem_grid %>% 
  select(f_finale) %>% 
  write.table(file = paste0(data_path,"spatial/compute_canada/mpa_sqb.txt"),
              sep="\t", col.names = F, row.names = F)

```



## Plot Map for supplements


```{r}

sau_sf <- my_sf("SAU") %>% 
filter(name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador"))


sq_map <- sq_dbem_grid %>% 
  # View()
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = f_finale,
      color = f_finale
    ) 
  ) +
  # scale_fill_gradient2() +
  # scale_color_gradient2() +
  scale_fill_viridis_b() +
  scale_color_viridis_b() +
  geom_sf(data = combined_sf, aes(), fill = "transparent", color = "white")  +
  geom_sf(data = sau_sf, aes(), fill = "transparent", color = "black")  +
  my_land_map()+ 
  coord_sf(
    xlim = c(-95,-77),
    ylim = c(-4,9)
  )

ggsave(
       "sq_scenario_map.png",
       sq_map)


```