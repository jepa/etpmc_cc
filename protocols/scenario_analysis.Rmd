---
title: "pred_dbem"
author: "Juliano Palacios Abrantes"
date: "2023-10-24"
output: html_document
---

```{r setup, include = F}

# source(here::here('./functions/function_list.R')) #I took these from mpa_c_toe
# source(here::here('./functions/figures_fx.R')) #Functions for creating figures

library(MyFunctions)

my_lib(c(
  # For grid estimation and species selection
  "spatialEco","tidyverse", "geosphere","raster","units","matrixStats","sf","rmapshaper", "igraph",
  # For collaborative ease
  "here",
  "readr",
  "janitor",
  # For nitce figures
  "hrbrthemes",
  "viridis",
  "parallel",
  "readxl"
))

# For grid e
# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)

select <- dplyr::select



# Global color pallets standardization

# Status pallet
status_pallet <- c("#00A08A", # Open
                   "#046C9A", # Protected
                   "#F98400" # Surrounding
) 

# SSP pallet
ssp_pallet <- c("#5BBCD6", #126
                "#FF0000" #585x
)

# Scenario pallet
scenario_pallet <- c("#02401B", # S1
                     "#FD6467", # S2
                     "#B6854D" # S3
)


# Change paths to your computer

data_path <- "~/Library/CloudStorage/GoogleDrive-jepa88@gmail.com/My Drive/lenfest_mpa_project/data/"


results_path <- "~/Library/CloudStorage/GoogleDrive-jepa88@gmail.com/My Drive/lenfest_mpa_project/manuscripts/scenarios_paper/results"
```



# Determine grid

```{r}

# Load SAU SF
sau_sf <- my_sf("SAU") %>% 
  filter(name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador"))

# Load Grid data
grid_path <- paste0(data_path,"spatial/gridded/all_mpa_grid_fe.csv")
mpas_grid <- read_csv(grid_path) %>% 
  rename(mpa_abrev = mpa) %>% 
  distinct()

cmar_grid <- my_data("dbem_coords") %>% 
  filter(lat < 10 & lat > -10 & lon > -100 & lon < -70) %>% 
  left_join(mpas_grid) %>% 
  left_join(my_data("sau_index")) %>% 
  mutate(status = ifelse(is.na(status),"non_protected",status),
         region = ifelse(is.na(mpa_abrev),eez_name,mpa_abrev)
  ) %>% 
  filter(!region %in% c("Colombia (Caribbean)","Panama (Caribbean)","Costa Rica (Caribbean)","El Salvador","Nicaragua (Pacific)","Peru","Venezuela"),
         !is.na(eez_name))

spp_groups <-  read_excel("~/Library/CloudStorage/GoogleDrive-jepa88@gmail.com/My Drive/lenfest_mpa_project/data/species/etp_spp_grouping.xlsx", 
                          skip = 1) %>% 
  filter(group != "mola")

# ggplot(cmar_grid) +
#   geom_tile(
#     aes(
#       x = lon,
#       y = lat,
#       fill = status
#     )
#   ) +
#   my_land_map()+
#   geom_sf(data = sau_sf, aes(), fill = "transparent") +
#   coord_sf(
#     xlim = c(-95,-77),
#     ylim = c(-4,9)
#   )

# facet_wrap(~mpa_abrev)




```

# Data processing

## Line trends of all models

```{r sppfx, eval = F, echo = F}


spp_fx <- function(taxon,variable){
  
  if(variable == "mcp"){
    to_read <- paste0(taxon,"Catch.RData")
  }else{
    to_read <- paste0(taxon,"Abd.RData")
  }
  
  for(m in 1:length(scen)){
    
    file_to_read <- paste0(scen[m],"/",to_read)
    
    if(file.exists(file_to_read)){
      
      load(file_to_read)
      
      spp_data <- as.data.frame(data) %>%
        rowid_to_column("index")
      rm(data)
      
      if(ncol(spp_data) == 251){
        colnames(spp_data) <- c("index",(seq(1851,2100,1)))
      }else{
        colnames(spp_data) <- c("index",(seq(1951,2100,1)))
      }
      
      time_line_data <- spp_data %>% 
        select(index,`1951`:`2100`) %>% 
        gather("year","value",`1951`:`2100`) %>% 
        filter(index %in% cmar_grid$index) %>% 
        left_join(cmar_grid,
                  by = "index",
                  relationship = "many-to-many") %>% 
        group_by(region,year) %>% 
        # Sum total catch per eez per year
        summarise(eez_value = sum(value, na.rm = T),.groups = "drop") %>% 
        mutate(
          taxon_key = taxon,
          esm = str_sub(file_to_read,65,68),
          ssp = ifelse(str_sub(file_to_read,69,70) == 26,"ssp126","ssp585"),
          scen = str_sub(file_to_read,73,74)
        )
      
      
      # Join data for all three models
      if(m == 1){
        partial_output <- time_line_data
      }else{
        partial_output <- bind_rows(partial_output,time_line_data)
      }
      
    }else{
      partial_output
      print(file_to_read)
    }
  }
  
  # print(paste(unique(partial_output$esm)))
  # print(paste(unique(partial_output$scen)))
  # print(paste(unique(partial_output$ssp)))
  # print(paste(unique(partial_output$region)))
  
  # Average ESMs +- SD
  final_output <- partial_output %>% 
    group_by(taxon_key,region,year,ssp,scen) %>% 
    mutate(mean_value_esm = mean(eez_value, na.rm = TRUE),
           sd_value_esm = sd(eez_value, na.rm =T)
    ) %>%
    # summarise(mean_value_esm = mean(period_value, na.rm =T),
    #           sd_value_esm = sd(period_value, na.rm =T),
    #           .groups = "drop") %>% 
    # remove cases where all three periods are 0
    # group_by(taxon_key,year,period,ssp) %>% 
    # filter(any(mean_value_esm != 0)) %>% 
    mutate(variable = variable)
  
  
  
  name <- paste0(taxon,"_",variable,"_period.csv")
  print(paste(unique(name)))
  
  write_csv(final_output,
            my_path("R","processed/species/period_data/",name))
  
  
} # Close function

```


```{r}

final_output %>% 
  group_by(year,taxon_key,esm,ssp,scen) %>% 
  summarise(sum_all_regions = sum(eez_value,na.rm = T),
            mean_all_region = sum(mean_value_esm)) %>% 
  filter(ssp == "ssp126") %>% 
  # View()
  ggplot() + 
  geom_line(
    aes(
      x = as.numeric(year),
      y = sum_all_regions,
      color = esm
    )
  ) +
  # average
  geom_line(
    aes(
      x = as.numeric(year),
      y = mean_all_region,
      color = "average"
    )
  ) +
  facet_grid(~scen)

```


## Percentage change analysis

### Per Species analysis


```{r sppfx, eval = F, echo = F}


spp_fx <- function(taxon,variable){
  
  if(variable == "catch"){
    to_read <- paste0(taxon,"Catch.RData")
  }else{
    to_read <- paste0(taxon,"Abd.RData")
  }
  
  for(m in 1:length(scen)){
    
    file_to_read <- paste0(scen[m],"/",to_read)
    
    if(file.exists(file_to_read)){
      
      load(file_to_read)
      
      spp_data <- as.data.frame(data) %>%
        rowid_to_column("index")
      rm(data)
      
      if(ncol(spp_data) == 251){
        colnames(spp_data) <- c("index",(seq(1851,2100,1)))
      }else{
        colnames(spp_data) <- c("index",(seq(1951,2100,1)))
      }
      
      early_data <- spp_data %>% 
        select(index,`1951`:`2100`) %>% 
        gather("year","value",`1951`:`2100`) %>% 
        filter(index %in% cmar_grid$index) %>% 
        mutate(period = ifelse(year < 2060 & year > 2041,"2060_mid",
                               ifelse(year < 2040 & year > 2021,"2040_ear",
                                      ifelse(year < 2100 & year > 2081,"2100_end",
                                             ifelse(year < 2014 & year > 1995,"2014_hist",
                                                    NA)
                                      )
                               )
                               
        )
        ) %>% 
        filter(!is.na(period)) %>% 
        left_join(cmar_grid,
                  by = "index",
                  relationship = "many-to-many") %>% 
        group_by(region,year,period) %>% 
        # Sum total catch per eez per year
        summarise(eez_value = sum(value, na.rm = T),.groups = "drop") %>% 
        group_by(region,period) %>% 
        # Average yearly data
        summarise(period_value = mean(eez_value,na.rm = T),.groups = "drop") %>% 
        mutate(
          taxon_key = taxon,
          esm = str_sub(file_to_read,65,68),
          ssp = ifelse(str_sub(file_to_read,69,70) == 26,"ssp126","ssp585"),
          scen = str_sub(file_to_read,73,74)
        )
      
      
      # Join data for all three models
      if(m == 1){
        partial_output <- early_data
      }else{
        partial_output <- bind_rows(partial_output,early_data)
      }
      
    }else{
      partial_output
      print(file_to_read)
    }
  }
  
  # print(paste(unique(partial_output$esm)))
  # print(paste(unique(partial_output$scen)))
  # print(paste(unique(partial_output$ssp)))
  # print(paste(unique(partial_output$region)))
  
  # Average ESMs +- SD
  final_output <- partial_output %>% 
    group_by(taxon_key,region,period,ssp,scen) %>% 
    summarise(mean_value_esm = mean(period_value, na.rm =T),
              sd_value_esm = sd(period_value, na.rm =T),
              .groups = "drop") %>% 
    # remove cases where all three periods are 0
    group_by(taxon_key,region,period,ssp) %>% 
    filter(any(mean_value_esm != 0)) %>% 
    mutate(variable = variable)
  
  
  
  name <- paste0(taxon,"_",variable,"_period.csv")
  print(paste(unique(name)))
  
  write_csv(final_output,
            my_path("R","processed/species/period_data/",name))
  
  
} # Close function

```


```{r}


dbem_spp <- my_data("sau_species")

# species list
etpmc_spp <- read.table("~/Library/CloudStorage/GoogleDrive-jepa88@gmail.com/My Drive/lenfest_mpa_project/data/species/EtpSppList10.txt", quote="\"", comment.char="") %>% 
  rename(taxon_key = V1) %>% 
  left_join(dbem_spp) %>% 
  filter(!taxon_key %in% c(600216, 600218,690032))

# ran_spp <- list.files(my_path("R","dbem_outputs/Rdata/c6gfdl26F1nr/",system = "juliano"))

# ran_spp <- str_sub(ran_spp,1,6)
# 
scen <-
  my_path("R","dbem_outputs/Rdata",
          list_files = "paths",
          system = "juliano")


# dbem_spp <- dbem_spp %>% 
# filter(!taxon_key %in% ran_spp)


mclapply(etpmc_spp$taxon_key, spp_fx, variable = "mcp", mc.cores = detectCores() - 4)

spp_fx(600006,"abd")

```

### Per Group analysis

```{r}
scen_group_dif_fx <- function(variable = "abd",grupo){
  
  
  selected_group <- spp_groups %>% 
    filter(group == grupo)
  
  
  if(variable == "abd"){
    name <- paste0(selected_group$taxon_key,"Abd.RData")
  }else{
    name <- paste0(selected_group$taxon_key,variable,".RData")
  }
  
  
  file_to_read <- paste0(my_path("R","dbem_outputs/Rdata",
                                 list_files = "paths",
                                 system = "juliano"),
                         "/",
                         name)
  
  
  for(i in 1:length(file_to_read)){
    
    # print(i)
    load(file_to_read[i])
    
    # Transform it to df
    spp_data <- as.data.frame(data) %>% 
      rowid_to_column("index") %>% 
      filter(index %in% cmar_grid$index)
    
    
    
    if(ncol(spp_data) == 251){
      colnames(spp_data) <- c("index",(seq(1851,2100,1)))
    }else{
      colnames(spp_data) <- c("index",(seq(1951,2100,1)))
    }
    
    rm(data) # remove data for computing power
    
    
    
    
    partial_data <- spp_data %>% 
      gather("year","value",`1951`:`2100`) %>% 
      filter(index %in% cmar_grid$index) %>% 
      mutate(period = ifelse(year < 2060 & year > 2041,"2060_mid",
                             ifelse(year < 2040 & year > 2021,"2040_ear",
                                    ifelse(year < 2100 & year > 2081,"2100_end",
                                           ifelse(year < 2014 & year > 1995,"2014_hist",
                                                  NA)
                                    )
                             )
                             
      )
      ) %>% 
      filter(!is.na(period)) %>% 
      mutate(
        esm = str_sub(file_to_read[i],65,68),
        ssp = ifelse(str_sub(file_to_read[i],69,70) == 26,"ssp126","ssp585"),
        scen = str_sub(file_to_read[i],73,74),
        group = grupo
      )
    
    
    
    # Join data for all three models
    if(i == 1){
      complete_output <- partial_data
    }else{
      
      complete_output <- full_join(complete_output,partial_data,
                                   by = c("index","year","period","esm","ssp","scen","group")
      ) %>% 
        mutate_at(
          .vars = c("value.x","value.y"),
          .funs = replace_na,0
        ) %>% 
        mutate(sum_value = value.x + value.y) %>% 
        select(index,esm,ssp,scen,group,year,period,value = sum_value)
      
    }
    
  } # close for loop in i for species
  
  
  final_output <- complete_output %>% 
    left_join(cmar_grid,
              by = "index",
              relationship = "many-to-many") %>% 
    group_by(scen,period,year,region,esm,group,ssp) %>% 
    #aggregate all grids
    summarise(
      sum_v = sum(value, na.rm = T),
      .groups = "keep"
    ) %>% 
    # Average time periods
    group_by(scen,period,region,group,esm,ssp) %>% 
    summarise(
      mean_value_tp = mean(sum_v, na.rm = T),
      .groups = "keep"
    ) %>% 
    # average per ESM
    group_by(scen,period,region,group,ssp) %>% 
    summarise(
      mean_value_esm = mean(mean_value_tp, na.rm = T),
      sd_value_esm = sd(mean_value_tp, na.rm =T),
      .groups = "keep"
    )
  # remove cases where all three periods are 0
  # group_by(group,region,period,ssp) %>% 
  # filter(any(mean_value_esm != 0)) %>% 
  # mutate(variable = variable)
  
  
  
  name <- paste0(grupo,"_",variable,"_period.csv")
  print(paste(unique(name)))
  
  write_csv(final_output,
            my_path("R","processed/groups/period_data/",name))
  
  
}


lapply(unique(spp_groups$group), scen_group_dif_fx, variable = "catch")
lapply(unique(spp_groups$group), scen_group_dif_fx, variable = "abd")


```

### Aggregated all analysis


```{r}


# This function aggregates all species per ESM and rcp and scenario
agg_esm_fx <- function(scenario, category){
  
  file_to_read <- my_path("R","dbem_outputs/Rdata",scenario,
                          list_files = "paths",
                          system = "juliano")
  
  file_to_read <- file_to_read[grep(category, file_to_read)]
  
  for(i in 1:length(file_to_read)){
    print(file_to_read[i])
    load(file_to_read[i])
    
    # Transform it to df
    spp_data <- as.data.frame(data) %>% 
      rowid_to_column("index") %>% 
      filter(index %in% cmar_grid$index)
    
    if(ncol(spp_data) == 251){
      colnames(spp_data) <- c("index",(seq(1851,2100,1)))
    }else{
      colnames(spp_data) <- c("index",(seq(1951,2100,1)))
    }
    rm(data) # remove data for computing power
    
    
    partial_data <- spp_data %>% 
      gather("year","value",`1951`:`2100`)
    
    # Join data for all three models
    if(i == 1){
      complete_output <- partial_data
    }else{
      
      complete_output <- left_join(complete_output,partial_data,
                                   by = c("index","year")
      ) %>% 
        mutate_at(
          .vars = c("value.x","value.y"),
          .funs = replace_na,0
        ) %>% 
        mutate(sum_value = value.x + value.y) %>% 
        select(index,year,value = sum_value)
      
    }
    
  } # close for loop in i for species
  
  final_df <-
    complete_output %>% 
    mutate(
      esm = str_sub(scenario,3,6),
      ssp = ifelse(str_sub(scenario,7,8)== 26,"ssp126","ssp585"),
      scen = str_sub(scenario,str_count(scenario)-1,str_count(scenario)),
      category = category
    ) %>% 
    filter(index %in% cmar_grid$index) %>% 
    mutate(period = ifelse(year < 2060 & year > 2041,"2060_mid",
                           ifelse(year < 2040 & year > 2021,"2040_ear",
                                  ifelse(year < 2100 & year > 2081,"2100_end",
                                         ifelse(year < 2014 & year > 1995,"2014_hist",
                                                NA)
                                  )
                           )
                           
    )
    ) %>% 
    filter(!is.na(period)) %>% 
    left_join(cmar_grid,
              by = "index",
              relationship = "many-to-many") %>% 
    # Aggregate grid cells
    group_by(region,year,esm,ssp,scen,period,category) %>% 
    summarise(sum_value = sum(value,na.rm = T),
              .groups = "keep") %>% 
    # average time periods
    group_by(region,esm,ssp,scen,period,category) %>% 
    summarise(mean_value_tp = mean(sum_value,na.rm = T),
              .groups = "keep")
  
  return(final_df)
  
}



```

```{r}

# List scenarios
scenarios <- list.files(my_path("R","dbem_outputs/Rdata",system = "juliano"))

# get data
scenarios_data <- bind_rows(
  lapply(scenarios, agg_esm_fx,category = "Catch")
)

#
agg_average_data <- scenarios_data %>%
  group_by(scen,region,period,category,ssp) %>%
  summarise(
    mean_value_esm = mean(mean_value_tp,na.rm =T),
    sd_value_esm = sd(mean_value_tp,na.rm =T),
  ) %>%
  write_csv(my_path("R","processed/all/period_data/","all_period_data_catch.csv"))


```


## Plots making

```{r}

# Load functions needed
sapply(list.files(here("functions/"),full.names = T), source)

dbem_spp <- my_data("sau_species")

# species list
etpmc_spp <- read.table("~/Library/CloudStorage/GoogleDrive-jepa88@gmail.com/My Drive/lenfest_mpa_project/data/species/EtpSppList10.txt", quote="\"", comment.char="") %>% 
  rename(taxon_key = V1) %>% 
  left_join(dbem_spp) %>% 
  filter(!taxon_key %in% c(600216, 600218,690032))


sau_sf <- my_sf("SAU") %>% 
  filter(name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador"))

cmar_sf <- read_sf(paste0(data_path,"spatial/cmar_capas/all_cmar_mpas.shp"))

spp_groups <-  read_excel("~/Library/CloudStorage/GoogleDrive-jepa88@gmail.com/My Drive/lenfest_mpa_project/data/species/etp_spp_grouping.xlsx", 
                          skip = 1) %>% 
  filter(group != "mola",
         taxon_key != 600226)


```

#### Change relative to historical time period (`relative_to_hist`)

##### Species

This section creates maps of change in variable relative to the historical period for each species and scenario


*Note that areas missing represent regions where the species is not present according to the model*

```{r}

# MAP

# hist_dif(600006, var = "abd", map = F)
# Run plot making
for(i in 1:2){
  vars <- c("abd","mcp")[i]
  mclapply(etpmc_spp$taxon_key, hist_dif, var = vars, mc.cores = detectCores() - 4)
  mclapply(etpmc_spp$taxon_key, hist_dif, var = vars, mc.cores = detectCores() - 4)
}


```


##### Groups

This section creates maps of change in variable relative to the historical period for each species group and scenario


*Note that areas missing represent regions where the group has values of zero*

```{r}


spp_groups_list <- unique(spp_groups$group)

# hist_dif("dorado", var = "abd")
# Run plot making
for(i in 1:2){
  vars <- c("abd","catch")[i]
  mclapply(spp_groups_list, hist_dif, var = vars, mc.cores = detectCores() - 4)
  mclapply(spp_groups_list, hist_dif, var = vars, mc.cores = detectCores() - 4)
}

```


##### Groups Facet


```{r}

groups_list <- my_path("R","processed/groups/period_data/",list_files = "paths")

groups_list <- groups_list[grep("abd", groups_list)]

groups_df <- bind_rows(
  lapply(groups_list, read_csv)
  ) %>% 
  filter(ssp == "ssp585")

per_chng_groups_period <- groups_df %>% 
    select(-sd_value_esm) %>% 
    pivot_wider(names_from = period, values_from = mean_value_esm) %>% 
    mutate(
      per_change = my_chng(`2014_hist`,`2040_ear`)
    ) %>% 
    select(
      scen,region, group, per_change
    ) %>% 
    # gather("scen","per_change",dif_nr:dif_rp) %>% 
    filter(!is.na(per_change)) %>%
    scenario_names() %>% 
    mutate(
    #   per_change = ifelse(per_change == "Inf",100,per_change),
      scenario = gsub(" ","\n" ,scenario)
    )

facet_map <- ggplot(per_chng_groups_period) +
      geom_sf(data = sau_sf %>% select(region = name) %>% left_join(per_chng_groups_period),
              aes(fill = per_change),
              color = "grey"
      ) +
      geom_sf(data = cmar_sf %>%  left_join(per_chng_groups_period),
              aes(fill = per_change),
              color = "black"
      ) +
      facet_grid(group~scenario) +
      # facet_wrap(~scenario) +
      scale_fill_gradient2("Percentage change relative to the SQ scenario by 2040") +
      # ggtitle(etpmc_spp %>% filter(taxon_key == taxon) %>% pull(common_name)) +
      # ggtitle(paste(category,var)) +
      my_ggtheme_m("Reg",facet_tl_s = 6,ax_tl_s = 6,ax_tx_s = 4,leg_tl_s = 4,leg_tx_s = 4) +
      theme(legend.text = element_text(size = 6),
            legend.title = element_text(size = 6),
            legend.key.height = unit(0.2, "line"),
            title = element_text(size = 6)
            ) +
        guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5))  


ggsave(
        my_path("R","figures/relative_to_hist/groups/","x_groups_facet_map_time.png"),
        facet_map,
        height = 7,
        width = 5)

```


##### All aggregated

This section creates maps of change in variable relative to the historical period for each species and scenario.


```{r}


data_paths <- my_path("R","processed/all/period_data/",list_files = "paths")

agg_data <- bind_rows(lapply(data_paths, read_csv))

spp_data <- agg_data %>% 
  select(-sd_value_esm) %>% 
  pivot_wider(names_from = period, values_from = mean_value_esm) %>% 
  mutate(
    dif_2040 = my_chng(`2014_hist`,`2040_ear`)
  ) %>% 
  select(
    scen:ssp,dif_2040
  ) %>% 
  scenario_names()


ssp_selected <- "ssp585"
category_selected = "Abd"

map_t <- ggplot() +
  geom_sf(data = sau_sf %>% select(region = name) %>%  left_join(spp_data) %>% filter(ssp == ssp_selected, category == category_selected),
          aes(fill = dif_2040),
          color = "grey"
  ) +
  geom_sf(data = cmar_sf %>%  left_join(spp_data) %>% filter(ssp == ssp_selected,category == category_selected),
          aes(fill = dif_2040),
          color = "black"
  ) +
  facet_wrap(~scenario) +
  scale_fill_gradient2("Diferencia relativa al valor historico (%)") +
  my_ggtheme_m("Reg",facet_tl_s = 6,ax_tl_s = 6,ax_tx_s = 3,leg_tl_s = 4,leg_tx_s = 4) +
  theme(legend.text = element_text(size = 6),
        legend.title = element_text(size = 6),
        legend.key.height = unit(0.2, "line"),
        title = element_text(size = 6)
  )

map_name <- paste0("map_",category_selected,"_",ssp_selected,"_time_diff.png")

ggsave(
  my_path("R",paste0("figures/relative_to_hist/all/"),map_name),
  map_t,
  height = 4,
  width = 5)


spp_data %>% 
  filter(ssp == ssp_selected,
         category == category_selected) %>% 
  mutate(region = gsub("_"," ",region)) %>% 
  ggplot() + 
  geom_bar(
    aes(
      x = region,
      y = dif_2040,
      fill = scenario
    ),
    stat = "identity",
    position = "dodge"
  ) +
  # facet_grid(~period) +
  scale_fill_viridis_d() +
  coord_flip() +
  labs(x="",
       y = "Change in value relative to historic (%)")+
  my_ggtheme_p(leg_pos = "right") +
  scale_x_discrete(limits = rev(sort(spp_data %>% mutate(region = gsub("_"," ",region)) %>% pull(region) %>% unique())))


bar_name <- paste0("bar_",category_selected,"_",ssp_selected,"_time_diff.png")

ggsave(
  my_path("R",paste0("figures/relative_to_hist/all/"),bar_name),
  last_plot(),
  height = 4,
  width = 7)


```



#### Change relative to SQ scenario (`scen_diff`)

##### Species

This analysis estimates the species percentage change relative to the SQ scenario in each time step

```{r}

scen_dif_fx(600006, "abd", map = F)

# Run plot making
mclapply(etpmc_spp$taxon_key, scen_dif_fx, var = "abd", 
         mc.cores = detectCores() - 4,
         map = F)

mclapply(etpmc_spp$taxon_key, scen_dif_fx, var = "mcp",
         mc.cores = detectCores() - 4,
         map = F)

```

##### Groups

This analysis estimates the group percentage change relative to the SQ scenario in each time step

```{r}


# Run plot making
# scen_dif_fx(
#   category = "dorado",
#   var = "catch",
#   ssp_selected = "ssp126"
#   )


for(i in 1:2){
  
  ssps <- c("ssp585","ssp126")[i]
  
  lapply(unique(spp_groups$group), scen_dif_fx,"abd",ssp_selected =ssps,
         map = F)
  lapply(unique(spp_groups$group), scen_dif_fx,"catch",ssps,
         map = F)
  
}

# lapply("dorado", scen_dif_fx,"Abd")


```


##### Groups Facet


```{r}

groups_list <- my_path("R","processed/groups/period_data/",list_files = "paths")

groups_list <- groups_list[grep("abd", groups_list)]

groups_df <- bind_rows(
  lapply(groups_list, read_csv)
  ) %>% 
  filter(ssp == "ssp585")

per_chng_groups_df <- groups_df %>% 
    select(-sd_value_esm) %>% 
    pivot_wider(names_from = scen, values_from = mean_value_esm) %>% 
    mutate(
      dif_nr = my_chng(sq,nr, limit = 100),
      dif_rc = my_chng(sq,rc, limit = 100),
      dif_ri = my_chng(sq,ri, limit = 100),
      dif_rp = my_chng(sq,rp, limit = 100)
    ) %>% 
    select(
      period,region, group, dif_nr:dif_rp
    ) %>% 
    gather("scen","per_change",dif_nr:dif_rp) %>% 
    filter(period == "2040_ear") %>% 
    scenario_names() %>% 
    filter(!is.na(per_change)) %>% 
    mutate(
      per_change = ifelse(per_change == "Inf",100,per_change),
      scenario = gsub(" ","\n" ,scenario)
    )

facet_map <- ggplot(per_chng_groups_df) +
      geom_sf(data = sau_sf %>% select(region = name) %>% left_join(per_chng_groups_df),
              aes(fill = per_change),
              color = "grey"
      ) +
      geom_sf(data = cmar_sf %>%  left_join(per_chng_groups_df),
              aes(fill = per_change),
              color = "black"
      ) +
      facet_grid(group~scenario) +
      # facet_wrap(~scenario) +
      scale_fill_gradient2("Percentage change relative to the SQ scenario by 2040") +
      # ggtitle(etpmc_spp %>% filter(taxon_key == taxon) %>% pull(common_name)) +
      # ggtitle(paste(category,var)) +
      my_ggtheme_m("Reg",facet_tl_s = 6,ax_tl_s = 6,ax_tx_s = 4,leg_tl_s = 4,leg_tx_s = 4) +
      theme(legend.text = element_text(size = 6),
            legend.title = element_text(size = 6),
            legend.key.height = unit(0.2, "line"),
            title = element_text(size = 6)
            ) +
        guides(fill = guide_colorbar(title.position = "top", title.hjust = 0.5))  


ggsave(
        my_path("R","figures/scen_diff/groups/","x_groups_facet.png"),
        facet_map,
        height = 7,
        width = 5)

```



##### All species

This analysis estimates the percentage change relative to the SQ scenario in each time step for all species aggregated

```{r}

data_paths <- my_path("R","processed/all/period_data/",list_files = "paths")

agg_data <- bind_rows(lapply(data_paths, read_csv))

spp_data <- agg_data %>% 
  select(-sd_value_esm) %>% 
  pivot_wider(names_from = scen, values_from = mean_value_esm) %>% 
  mutate(
    dif_nr = my_chng(sq,nr),
    dif_rc = my_chng(sq,rc),
    dif_ri = my_chng(sq,ri),
    dif_rp = my_chng(sq,rp)
  ) %>% 
  select(
    period,category,ssp,region, dif_nr:dif_rp
  ) %>% 
  gather("scen","per_change",dif_nr:dif_rp) %>% 
  filter(period != "2014_hist",
         !is.na(region)
  ) %>% 
  scenario_names()

# spp_data


ssp_selected <- "ssp126"
category_selected = "Catch"

map_t <- ggplot() +
  geom_sf(data = sau_sf %>% select(region = name) %>%  left_join(spp_data) %>% filter(ssp == ssp_selected, category == category_selected),
          aes(fill = per_change),
          color = "grey"
  ) +
  geom_sf(data = cmar_sf %>%  left_join(spp_data) %>% filter(ssp == ssp_selected,category == category_selected),
          aes(fill = per_change),
          color = "black"
  ) +
  facet_wrap(~scenario) +
  scale_fill_gradient2("Percentage change relative to the SQ scenario by 2040") +
  my_ggtheme_m("Reg",facet_tl_s = 6,ax_tl_s = 6,ax_tx_s = 3,leg_tl_s = 4,leg_tx_s = 4) +
  theme(legend.text = element_text(size = 6),
        legend.title = element_text(size = 6),
        legend.key.height = unit(0.2, "line"),
        title = element_text(size = 6)
  )

map_name <- paste0(category_selected,"_",ssp_selected,"_time_diff.png")

ggsave(
  my_path("R",paste0("figures/scen_diff/all/"),map_name),
  map_t,
  height = 4,
  width = 5)


spp_data %>% 
  filter(ssp == ssp_selected,
         category == category_selected) %>% 
  mutate(region = gsub("_"," ",region)) %>% 
  ggplot() + 
  geom_bar(
    aes(
      x = region,
      y = per_change,
      fill = scenario
    ),
    stat = "identity",
    position = "dodge"
  ) +
  # facet_grid(~period) +
  scale_fill_viridis_d() +
  coord_flip() +
  labs(x="",
       y = "Change in value relative to historic (%)")+
  my_ggtheme_p(leg_pos = "right") +
  scale_x_discrete(limits = rev(sort(spp_data %>% mutate(region = gsub("_"," ",region)) %>% pull(region) %>% unique())))


bar_name <- paste0("bar_",category_selected,"_",ssp_selected,"_time_diff.png")

ggsave(
  my_path("R",paste0("figures/scen_diff/all/"),bar_name),
  last_plot(),
  height = 4,
  width = 7)

```

#### Change relative to SQ scenario in 2014  (`historica/period`)

##### All

This analysis estimates the group percentage change relative to the SQ scenario in the historical time step (fixed)

```{r}

hist_data <- agg_data %>% 
  filter(scen == "sq",
         period == "2014_hist") %>% 
  select(region,category,ssp,mean_value_esm_sq = mean_value_esm)

period_data <- agg_data %>% 
  filter(scen != "sq",
         period != "2014_hist") %>%
  left_join(hist_data,
  ) %>% 
  select(-sd_value_esm) %>% 
  pivot_wider(names_from = period, values_from = mean_value_esm) %>% 
  mutate(
    per_change = my_chng(mean_value_esm_sq,`2040_ear`)
  ) %>% 
  select(
    scen,category,ssp,region, per_change
  ) %>% 
  # gather("period","per_change",dif_2040:dif_2100) %>% 
  filter(!is.na(region)
  ) %>% 
  scenario_names()

# Create plot
per_change_map(df = period_data,
               level = "agg",
               ssp_selected = "ssp126",
               cat_selected = "Catch",
               relative = "period_diff")

```


### Change relative to SQ scenario in 2014 (`historical/scen`)

```{r}

hist_data <- agg_data %>% 
  filter(scen == "sq",
         period == "2014_hist") %>% 
  select(region,category,ssp,mean_value_esm_sq = mean_value_esm)


scen_data <- agg_data %>% 
  filter(scen != "sq",
         period != "2014_hist") %>% 
  left_join(hist_data) %>% 
  select(-sd_value_esm) %>% 
  pivot_wider(names_from = scen, values_from = mean_value_esm) %>% 
  mutate(
    dif_nr = my_chng(mean_value_esm_sq,nr),
    dif_rc = my_chng(mean_value_esm_sq,rc),
    dif_ri= my_chng(mean_value_esm_sq,ri),
    diff_rp = my_chng(mean_value_esm_sq,rp)
  ) %>% 
  select(
    period,category,ssp,region, dif_nr:diff_rp
  ) %>% 
  gather("scen","per_change",dif_nr:diff_rp) %>% 
  filter(period != "2014_hist",
         !is.na(region)
  ) %>% 
  scenario_names()


# Create plot
per_change_map(df = scen_data,
               level = "agg",
               ssp_selected = "ssp585",
               cat_selected = "Abd",
               relative = "scen_diff")
```




