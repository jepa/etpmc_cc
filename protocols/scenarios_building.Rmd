---
title: "Scenarios Construction"
author: "Juliano Palacios-Abrantes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}

library(MyFunctions)

my_lib(
  c(
    "readxl",
    "tidyverse",
    "sf",
    "st",
    "janitor",
    "here",
    # For grid estimation 
    "spatialEco", "geosphere","raster","units","matrixStats","rmapshaper", "igraph",
    # For saptial... stuff
    "rnaturalearth"
  )
)

# Fix new updates of sf package
sf::sf_use_s2(use_s2 = FALSE)

select <- dplyr::select

knitr::opts_chunk$set(echo = TRUE)


# Change paths to your computer

data_path <- "~/Library/CloudStorage/GoogleDrive-jepa88@gmail.com/My Drive/lenfest_mpa_project/data/"

results_path <- "~/Library/CloudStorage/GoogleDrive-jepa88@gmail.com/My Drive/lenfest_mpa_project/manuscripts/scenarios_paper/results"


# Load functions

source(here("functions/prior_prot_fx.R"))


```

# Scenario 1: Status quo

**i. Status Quo:** This scenario aims to represent, as accurately as possible, the current management of the region in terms of fishing and conservation. To inform this scenario, questions were asked regarding current levels of illegal fishing (if any), monitoring and surveillance of Marine Protected Areas (MPAs), fishing effort outside protected areas, and management strategies for MPAs. Participants responded based on their experience in the subject and in each protected area. This scenario was used as a starting point in the model to later compare with alternative management scenarios.


```{r}

# Load Grid data
grid_path <- paste0(data_path,"spatial/gridded/all_mpa_grid_fe.csv")

# Load Fishing effort data
scenarios <- read_excel(paste0(data_path,"spatial/scenarios_info.xlsx")) %>% 
  filter(fishing != "yes")

remove_mpa <- read_excel(paste0(data_path,"spatial/scenarios_info.xlsx")) %>% 
  filter(fishing == "yes")

mpas_grid <- read_csv(grid_path) %>% 
  rename(mpa_abrev = mpa) %>% 
  filter(!mpa_abrev %in% remove_mpa$mpa_abrev)

# combined mpas
combined_sf <- read_sf(paste0(data_path,"spatial/cmar_capas/all_cmar_mpas.shp"))

# DBEM grid
dbem_grid <- my_data("dbem_coords")

# unique(mpas_grid$mpa_abrev)

```

# Fix surrounding
For the purpuse of the analysis, surrounding gridcells around MPAs when f = 1 inside the MPA are treated as a regular EEZ grid. This is because there is no point in increasing effort in these regions because fishing is not really re-distributed. 

```{r}

mpas_grid <- mpas_grid %>% 
  left_join(scenarios %>% filter(scen == "status_quo")) %>% 
  filter(f_plan < 1) 


mpas_grid %>% 
  left_join(dbem_grid) %>% 
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = status,
      color = status
    ) 
    # color = "black"
  ) +
  # scale_fill_gradient2() +
  # scale_color_gradient2() +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  geom_sf(data = combined_sf, aes(), fill = "transparent", color = "black")  +
  my_land_map()+ 
  coord_sf(
    xlim = c(-95,-77),
    ylim = c(-4,9)
    # xlim = c(-94,-85),
    # ylim = c(-1,4)
  )

  
```




## Re-calculate fishing effort

We need to re-calculate fishing effort for the MPAs that are smaller than our grid cell. We asume that only a fraction of the grid is protected, however, given the different characteristics of each scenario, fishing mortality needs to be adjusted for such fraction. This way, we allocated fishing effort as a fraction of F_MSY (F/F_MSY) as follows:

When a gird cell is protected and the management scenario allows for fishing in the whole area then $\frac{F}{FMSY}$ = *f_scen*.where *f_scen*is the fishing effort determined at the workshop. When a gird cell is protected and the management plan restricts some level of fishing, then 

$$\frac{F}{FMSY} = (f_{prop}*f_{scen})+((1-f_{prop})*f_{out})$$
where $f_{prop}$ is the proportion of the grid that is protected by the MPA, $f_{scen}$ is the fishing effort allowed within the MPA as defined by the workshop, and $f_{out}$ is the scenario fishing level of un-protected grid cells. 

For grid cells that are surrounding an MPA, $\frac{F}{FMSY}$ = $f_{prop}*f_{out}$ to account for the often reported re-allocation of fishing effort given MPA restrictions. Finally, for all other grid cells within the EEZs of Costa Rica, Colombia, Ecuador and Panama (*unprotected*) $\frac{F}{FMSY}$ = $f_{out}$.


```{r}

sq_mpa_grid_f <- mpas_grid %>% 
  # filter()
  left_join(scenarios %>% filter(scen == "status_quo")
            ) %>%
  mutate(
    # For protected areas
    f_finale = ifelse(status == "protected" & f_plan == 1,f_scen,
                    ifelse(status == "protected" & f_plan != 1,((1-fe_prop)*f_scen)+(fe_prop*f_out),
                           ifelse(status == "surrounding" & f_plan < 1,fe_prop*f_out,
                           f_scen
                           )
    )
  )
  ) %>%   
  # select(-6:-9,-notes) %>% 
  prior_prot() # function for prioritization of duplicates


# Double check grid
status_grid <- sq_mpa_grid_f %>%
  left_join(dbem_grid) %>% 
  filter(status %in% c("protected","surrounding")) %>%
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      # fill = fe_prop
      fill = status
    )
    # color = "white"
  ) +
  geom_sf(data = combined_sf, aes(), fill = "transparent", color = "grey") +
  # facet_wrap(~mpa_abrev) +
  scale_fill_viridis_d()

ggsave(
  paste0(data_path,"/spatial/gridded/a_status_grid.png"),
  # paste0(data_path,"/spatial/gridded/a_status_grid_all.png"),
  # paste0(data_path,"/spatial/gridded/a_f_finale_grid.png"),
  # paste0(data_path,"/spatial/gridded/a_status_grid_all.png"),
  status_grid,
  width = 7,
  height = 7)


```

### Fix Galapagos land issue

Because galaoagos MPA has, well, Galapagos, the land polygon is messing up the pixel area estimation because it thinks that the protected area is less than the total pixel area (because of land)


```{r eval = F}

# Manually tdentify what grids are problematic
 gal_map <- sq_dbem_grid %>%
  filter(status %in% c("protected","surrounding")) %>%
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = f_finale
      # fill = status
    ),
    alpha = 0.4
    # color = "white"
  ) +
  geom_text(
    aes(
      x = lon,
      y = lat,
      label = index
    )
  ) +
  geom_sf(data = combined_sf, aes(), fill = "transparent", color = "grey") +
  # facet_wrap(~mpa_abrev) +
  scale_fill_viridis_c() +
  coord_sf(
    xlim = c(-95,-85),
    ylim = c(-4,4)
  )

# Save figure for eas viz
ggsave("galapagos_land_index.png",x,
       width = 17,
       height = 17)

# Identified problematic grids
galapagos_land <- c(128339,128340,129057,129058,129059,129060,129061,129777,129778,129779,130497,130498,130499,130500,130501,130502,131218,131219,131220,131221,129780)

    # Fix final grid
sq_dbem_grid_gp <- sq_mpa_grid_f %>% 
  left_join(dbem_grid) %>% 
  mutate(
    f_finale = ifelse(index %in% galapagos_land, 0.2000000,f_finale)
  )

  # Double check fix
gal_map <- sq_dbem_grid_gp %>%
  filter(status %in% c("protected","surrounding")) %>%
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = f_finale
      # fill = status
    ),
    alpha = 0.4
    # color = "white"
  ) +
  geom_text(
    aes(
      x = lon,
      y = lat,
      label = index
    )
  ) +
  geom_sf(data = combined_sf, aes(), fill = "transparent", color = "grey") +
  # facet_wrap(~mpa_abrev) +
  scale_fill_viridis_c() +
  coord_sf(
    xlim = c(-95,-85),
    ylim = c(-4,4)
  )
   
   ggsave("fix.png",gal_map,
       width = 17,
       height = 17)


```


## Merge MPA grid with rest of the world

Here we merged the MPA grid and create the DBEM layer for Compute Canada (CC)

### EEZs sub scenario

In this scenario, we assumed that the rest of the ETP EEZs are fished at F/FMSY = 1.3 while the rest of the world is F/FMSY = 1, including the reion's high seas under the assumption that ICCAT has proper managmeent of the region

```{r, etp_eez_fishing, eval = T}

# Identified problematic grids
galapagos_land <- c(128339,128340,129057,129058,129059,129060,129061,129777,129778,129779,130497,130498,130499,130500,130501,130502,131218,131219,131220,131221,129780)

etp_eez_index_sq <- my_data("sau_index") %>% 
   filter(eez_name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador")) %>% 
  select(index) %>% 
  filter(!index %in% sq_mpa_grid_f$index) %>% 
  # mutate(rfmo_name = "IATTC") %>% 
  mutate(f_finale = 1.3,
         status = "unprotected",
         mpa_abrev = NA,
         scen = "status quo")# %>% 
  
# Double check grid
# etp_eez_index_sq %>% 
#   left_join(dbem_grid) %>% 
#   ggplot() +
#   geom_tile(
#     aes(
#       x = lon,
#       y = lat,
#       fill = "status"
#     )
#   ) +
#   geom_sf(data = combined_sf, aes(), fill = "transparent", color = "black")

sq_dbem_grid <- dbem_grid %>% 
  left_join(sq_mpa_grid_f,
            by ="index") %>% 
  mutate(
    # f_finale_plot = ifelse(f_finale > 1, f_finale, f_finale*-1),
    f_finale = ifelse(is.na(status) & index %in% etp_eez_index_sq$index, 1.3,
                      ifelse(is.na(status) & ! index %in% etp_eez_index_sq$index,1, f_finale)
    )
  ) %>%
  # fix galapagos
  mutate(
    f_finale = ifelse(index %in% galapagos_land, 0.2000000,f_finale)
  )

# Wirte grid for compute canada
sq_dbem_grid %>%
  select(f_finale) %>%
  write.table(file = paste0(data_path,"spatial/compute_canada/mpa_sq.txt"),
              sep="\t",
              col.names = F,
              row.names = F)

```

## Plot Map for supplements


```{r}

sau_sf <- my_sf("SAU") %>% 
filter(name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador"))


sq_map <- sq_dbem_grid %>% 
  # filter(status == "protected") %>%
  # filter(status == "surrounding") %>%
  # filter(status %in% c("surrounding","protected")) %>%
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = f_finale,
      color = f_finale
    ) 
  ) +
  # scale_fill_gradient2() +
  # scale_color_gradient2() +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  geom_sf(data = combined_sf, aes(), fill = "transparent", color = "black")  +
  geom_sf(data = sau_sf, aes(), fill = "transparent", color = "black")  +
  my_land_map()+ 
  coord_sf(
    xlim = c(-95,-77),
    ylim = c(-4,9)
    # xlim = c(-94,-85),
    # ylim = c(-1,4)
  )

ggsave(
       paste0(results_path,"/scenarios/sq_scenario_map.png"),
       sq_map)


```

# Scenario 2: Best Case (regulation implemented / ri)

All regulations are implemented, and the fishing area within the marine protected areas is equivalent to the area specified in the management plan, or does not exist when no information is available. The fishing intensity, where permitted, is that of MSY


```{r}

scen_reg_implement <- mpas_grid %>% 
  left_join(scenarios %>% filter(scen == "reg_implement"))

etp_eez_index_ri <- my_data("sau_index") %>% 
   filter(eez_name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador")) %>% 
  select(index) %>% 
  filter(!index %in% scen_reg_implement$index) %>% 
  mutate(f_finale = 1,
         status = "unprotected",
         mpa_abrev = NA,
         scen = "status reg_implement")


ri_dbem_grid <- dbem_grid %>% 
  left_join(scen_reg_implement,
            by ="index") %>% 
  mutate(
    f_finale = ifelse(is.na(status) & index %in% etp_eez_index_ri$index, 1,
                      ifelse(is.na(status) & ! index %in% etp_eez_index_ri$index,1,
                             ifelse(status == "surrounding",fe_prop*1,
                                    ifelse(status == "protected" & fe_prop == 0,f_plan,
                                           ((1-fe_prop)*f_plan)+fe_prop)
                             )
                      )
    )
  ) %>%
  prior_prot() %>% # function for prioritization of duplicates
  # fix galapagos
  mutate(
    f_finale = ifelse(index %in% galapagos_land, f_plan,f_finale)
  )

# sq_dbem_grid %>% 
#   filter(!is.na(status)) %>% 
#   View()


# Wirte grid for compute canada
ri_dbem_grid %>%
  select(f_finale) %>%
  write.table(file = paste0(data_path,"spatial/compute_canada/mpa_ri.txt"),
              sep="\t", col.names = F, row.names = F)

```

## Plot Map for supplements

```{r}

# sau_sf <- my_sf("SAU") %>% 
# filter(name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador"))


ri_map <- ri_dbem_grid %>% 
  # filter(status == "protected") %>%
  # filter(status == "surrounding") %>%
  # filter(status %in% c("surrounding","protected")) %>%
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = f_finale,
      color = f_finale
    ) 
  ) +
  # scale_fill_gradient2() +
  # scale_color_gradient2() +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  geom_sf(data = combined_sf, aes(), fill = "transparent", color = "white")  +
  geom_sf(data = sau_sf, aes(), fill = "transparent", color = "black")  +
  my_land_map()+ 
  coord_sf(
    xlim = c(-95,-77),
    ylim = c(-4,9)
  )

ggsave(
       paste0(data_path,"../manuscripts/scenarios_paper/results/scenarios/ri_scenario_map.png"),
       ri_map)


```


# Scenario 3: Partial regulations For conservation (reg_par_con / rpc)

Conservation regulations are implemented, and the fishing area within the marine protected areas is equivalent to the area specified in the management plan. Fishing intensity in the region is maintained at 30% above the level required for MSY

*Requires SQ data*

```{r}


scen_reg_implement <- mpas_grid %>% 
  left_join(scenarios %>% filter(scen == "reg_implement"))

etp_eez_index_ri <- my_data("sau_index") %>% 
   filter(eez_name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador")) %>% 
  select(index) %>% 
  filter(!index %in% scen_reg_implement$index) %>% 
  mutate(f_finale = 1,
         status = "unprotected",
         mpa_abrev = NA,
         scen = "status reg_implement")


rpc_dbem_grid <- dbem_grid %>% 
  left_join(scen_reg_implement,
            by ="index") %>% 
  mutate(
    f_finale = ifelse(is.na(status) & index %in% etp_eez_index_ri$index, 1.3,
                      ifelse(is.na(status) & ! index %in% etp_eez_index_ri$index,1,
                             ifelse(status == "surrounding",fe_prop*1.3,
                                    ifelse(status == "protected" & fe_prop == 0,f_plan,
                                           ((1-fe_prop)*f_plan)+fe_prop)
                             )
                      )
    )
  ) %>%
  prior_prot() %>% # function for prioritization of duplicates
  # fix galapagos
  mutate(
    f_finale = ifelse(index %in% galapagos_land, f_plan,f_finale)
  )

# Wirte grpcd for compute canada
# rpc_dbem_grid %>% 
#   select(f_finale) %>% 
#   write.table(file = paste0(data_path,"spatial/compute_canada/mpa_rpc.txt"),
#               sep="\t", col.names = F, row.names = F)

```


## Plot Map for supplements


```{r}

rpc_map <- rpc_dbem_grid %>% 
  # filter(status == "protected") %>%
  # filter(status == "surrounding") %>%
  # filter(status %in% c("surrounding","protected")) %>%
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = f_finale,
      color = f_finale
    ) 
  ) +
  # scale_fill_gradient2() +
  # scale_color_gradient2() +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  geom_sf(data = combined_sf, aes(), fill = "transparent", color = "white")  +
  geom_sf(data = sau_sf, aes(), fill = "transparent", color = "black")  +
  my_land_map()+ 
  coord_sf(
    xlim = c(-95,-77),
    ylim = c(-4,9)
  )

ggsave(
       paste0(data_path,"../manuscripts/scenarios_paper/results/scenarios/rpc_scenario_map.png"),
       rpc_map)


```

# Scenario 4: Partial rgulations For fisheries (reg_par_pes / rpp)

Fishing regulations are implemented. The fishing area within the marine protected areas is 20% larger than the area specified in the management plan. Fishing intensity in the region is at the level required for MSY

```{r}

sq_mpa_grid_f <- mpas_grid %>% 
  left_join(scenarios %>% filter(scen == "status_quo")) %>% 
  mutate(
    # For protected areas
    f_finale = ifelse(status == "protected" & f_plan == 1,f_scen,
                    ifelse(status == "protected" & f_plan != 1,((1-fe_prop)*f_scen)+(fe_prop*f_out),
                           ifelse(status == "surrounding",fe_prop*f_out,
                           f_scen
                           )
    )
  )
  )

etp_eez_index_sq <- my_data("sau_index") %>%
   filter(eez_name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador")) %>%
  select(index) %>%
  filter(!index %in% sq_mpa_grid_f$index) %>%
  # mutate(rfmo_name = "IATTC") %>%
  mutate(f_finale = 1,
         status = "unprotected",
         mpa_abrev = NA,
         scen = "status quo")


rpp_dbem_grid <- dbem_grid %>% 
  left_join(sq_mpa_grid_f,
            by ="index") %>% 
  mutate(
    f_finale = ifelse(is.na(status), 1,
                      ifelse(status == "surrounding",fe_prop,
                             f_finale
                      )
    )
  ) %>%
  prior_prot() %>% # function for prioritization of duplicates
  # fix galapagos
  mutate(
    f_finale = ifelse(index %in% galapagos_land, f_scen,f_finale)
  )


# sq_dbem_grpcd %>% 
#   filter(!is.na(status)) %>% 
#   View()


# Wirte grpcd for compute canada
# rpp_dbem_grid %>% 
#   select(f_finale) %>% 
#   write.table(file = paste0(data_path,"spatial/compute_canada/mpa_rpp.txt"),
#               sep="\t", col.names = F, row.names = F)



# rpp_dbem_grid %>% 
#   select(f_finale) %>% 
#   bind_cols(rpc_dbem_grid %>% select(f_finale)) %>% 
#   mutate(f_finale...1 - f_finale...2) %>% 
#   View()


```


## Plot Map for supplements


```{r}

rpp_map <- rpp_dbem_grid %>% 
  # filter(status == "protected") %>%
  filter(status == "surrounding") %>%
  # filter(status %in% c("surrounding","protected")) %>%
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = f_finale,
      color = f_finale
    ) 
  ) +
  # scale_fill_gradient2() +
  # scale_color_gradient2() +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  geom_sf(data = combined_sf, aes(), fill = "transparent", color = "white")  +
  geom_sf(data = sau_sf, aes(), fill = "transparent", color = "black")  +
  my_land_map()+ 
  coord_sf(
    xlim = c(-95,-77),
    ylim = c(-4,9)
  )

ggsave(
       paste0(data_path,"../manuscripts/scenarios_paper/results/scenarios/rpp_scenario_map_s.png"),
       rpp_map)


```

# Scenario 5: No regulations (nr)

Regulations are not implemented, and the fishing area within the marine protected areas is 50% larger than the area stipulated in the management plan. Fishing intensity in the region is 50% higher than the level required for MSY.

```{r}

# Set status quo grid
np_mpa_grid_f <- mpas_grid %>% 
  left_join(scenarios %>% filter(scen == "reg_par_no")) %>% 
  mutate(
    # For protected areas
    f_finale = ifelse(status == "protected" & f_plan == 1,f_scen,
                      ifelse(status == "protected" & f_plan != 1,((1-fe_prop)*f_scen)+(fe_prop*f_out),
                             ifelse(status == "surrounding",fe_prop*f_out,
                                    f_scen
                             )
                      )
    )
  )


# Regional grid (non-map realted)
etp_eez_index_np <- my_data("sau_index") %>% 
   filter(eez_name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador")) %>% 
  select(index) %>% 
  filter(!index %in% np_mpa_grid_f$index) %>% 
  # mutate(rfmo_name = "IATTC") %>% 
  mutate(f_finale = 1.5, # according to current scneario
         status = "unprotected",
         mpa_abrev = NA,
         scen = "status quo")



nr_dbem_grid <- dbem_grid %>% 
  left_join(np_mpa_grid_f,
            by ="index") %>% 
  mutate(
    f_finale = ifelse(is.na(status) & index %in% etp_eez_index_np$index, 1.5,
                      ifelse(is.na(status) & ! index %in% etp_eez_index_np$index,1,
                             f_finale
                      )
    )
  ) %>%
  prior_prot() %>% 
  # fix galapagos
  mutate(
    f_finale = ifelse(index %in% galapagos_land, f_scen,f_finale)
  )

# sq_dbem_grpcd %>% 
#   filter(!is.na(status)) %>% 
#   View()


# Wirte grpcd for compute canada
nr_dbem_grid %>% 
  select(f_finale) %>% 
  write.table(file = paste0(data_path,"spatial/compute_canada/mpa_nr.txt"),
              sep="\t", col.names = F, row.names = F)

```


## Plot Map for supplements

```{r}

nr_map <- nr_dbem_grid %>% 
  # View()
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = f_finale,
      color = f_finale
    ) 
  ) +
  # scale_fill_gradient2() +
  # scale_color_gradient2() +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  geom_sf(data = combined_sf, aes(), fill = "transparent", color = "white")  +
  geom_sf(data = sau_sf, aes(), fill = "transparent", color = "black")  +
  my_land_map()+ 
  coord_sf(
    xlim = c(-95,-77),
    ylim = c(-4,9)
  )

ggsave(
       paste0(data_path,"../manuscripts/scenarios_paper/results/scenarios/nr_scenario_map.png"),
       nr_map)


```

# All

```{r}

scenario_pannel <-
  bind_rows(
  sq_dbem_grid %>% mutate(scen = "Status quo"),
  nr_dbem_grid %>% mutate(scen = "No Regulations"),
  ri_dbem_grid %>% mutate(scen = "Regulations implemented"),
  rpp_dbem_grid %>% mutate(scen = "Regulations for fishing"),
  rpc_dbem_grid %>% mutate(scen = "Regulations for conservation")
) %>% 
  # View()
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = f_finale,
      color = f_finale
    ) 
  ) +
  scale_fill_viridis_c("F mort/F msy") +
  scale_color_viridis_c("F mort/F msy") +
  geom_sf(data = sau_sf, aes(), fill = "transparent", color = "black")  +
  geom_sf(data = combined_sf, aes(), fill = "transparent", color = "red")  +
  my_land_map()+ 
  my_ggtheme_m("Reg",facet_tl_s = 6,ax_tl_s = 6,ax_tx_s = 4,leg_tl_s = 4,leg_tx_s = 4) +
  labs(x = "Latitude",
       y = "Longitude") +
  coord_sf(
    xlim = c(-95,-77),
    ylim = c(-4,9)
  ) +
  facet_wrap(~scen)

ggsave(
  paste0(data_path,"../manuscripts/scenarios_paper/results/scenarios/scenario_pannel.png"),
  scenario_pannel,
  width = 8,
  height = 5)

```


# OLD CODE 

### IATTC sub-scenario

In this scenario, we assumed that the whole IATCC region is fihsed at F/FMSY = 1.3 while the rest of the world is F/FMSY = 1.

```{r iattc_fishing, eval = F}

regional_index_sq <- read.csv(paste0(data_path,"spatial/iattc_gridded.csv")) %>% 
   # filter(eez_name %in% c("Costa Rica (Pacific)","Colombia (Pacific)","Panama (Pacific)","Galapagos Isl. (Ecuador)", "Ecuador")) %>% 
  select(index) %>% 
  # mutate(rfmo_name = "IATTC") %>% 
  # bind_rows(
  # my_path("Spa","SAU/SAU_RFMO", "RFMO_Index_Code.csv", read = T)
  # ) %>% 
  # filter(rfmo_name == "IATTC") %>% 
  select(index) %>% 
  mutate(f_finale = 1.3,
         status = "unprotected",
         mpa_abrev = NA,
         scen = "status quo") %>% 
  left_join(dbem_grid)

# Identified problematic grids
galapagos_land <- c(128339,128340,129057,129058,129059,129060,129061,129777,129778,129779,130497,130498,130499,130500,130501,130502,131218,131219,131220,131221,129780)

# Get the MPA grid
sq_dbem_grid <- dbem_grid %>% 
  left_join(sq_mpa_grid_f,
            by ="index") %>% 
  select(index,lon,lat,status,mpa_abrev,status,scen,f_finale) %>% 
  mutate(
    # f_finale_plot = ifelse(f_finale > 1, f_finale, f_finale*-1),
    f_finale = ifelse(is.na(status) & index %in% regional_index_sq$index, 1.3,
                      ifelse(is.na(status) & ! index %in% regional_index_sq$index,1, f_finale)
    )
  ) %>% 
  # fix galapagos
  mutate(
    f_finale = ifelse(index %in% galapagos_land, 0.2000000,f_finale)
  )

sq_dbem_grid %>%
  left_join(dbem_grid) %>% 
  # filter(index %in% sq_map$index,
         # fe_prop > 1) %>%
  # View()
  ggplot() +
  geom_tile(
    aes(
      x = lon,
      y = lat,
      fill = fe_prop
      # color = fe_prop
    ) ,
    color = "black"
  ) +
  # scale_fill_gradient2() +
  # scale_color_gradient2() +
  scale_fill_viridis_c() +
  scale_color_viridis_c() +
  geom_sf(data = combined_sf, aes(), fill = "transparent", color = "black")  +
  my_land_map()+ 
  coord_sf(
    xlim = c(-95,-77),
    ylim = c(-4,9)
    # xlim = c(-93,-88),
    # ylim = c(-2,2)
  )



# Wirte grid for compute canada
# sq_dbem_grid %>% 
#   select(f_finale) %>% 
#   write.table(file = paste0(data_path,"spatial/compute_canada/mpa_sq.txt"),
#               sep="\t", col.names = F, row.names = F)

```